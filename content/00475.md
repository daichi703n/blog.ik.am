---
title: Spring BatchをCloud Foundry上で実行する際のTips
categories: ["Programming", "Java", "org", "springframework", "batch"]
tags: ["Java", "Spring", "Spring Batch", "Spring Boot", "Cloud Foundry", "Pivotal Web Services"]
---

Spring BatchをCloud Foundry上で使う際のうまく実行するTipsのメモ

**目次**

<!-- toc -->

### Hello WorldなSpring Batchアプリケーションの作成

まずは簡単なBatchアプリケーションを作成します。ジョブのメタデータや実行履歴を保存するデータベースは組み込みのH2を使用します。

```
curl start.spring.io/starter.tgz \
       -d artifactId=hello-spring-batch \
       -d baseDir=hello-spring-batch \
       -d packageName=com.example \
       -d dependencies=batch,h2 \
       -d applicationName=HelloSpringBatchApplication | tar -xzvf -

cd hello-spring-batch
```

Hello Worldな`Tasklet`を一つ定義します。

```java
cat <<EOF > src/main/java/com/example/JobConfig.java
package com.example.hello;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.batch.core.Job;
import org.springframework.batch.core.Step;
import org.springframework.batch.core.configuration.annotation.EnableBatchProcessing;
import org.springframework.batch.core.configuration.annotation.JobBuilderFactory;
import org.springframework.batch.core.configuration.annotation.StepBuilderFactory;
import org.springframework.batch.core.launch.support.RunIdIncrementer;
import org.springframework.batch.repeat.RepeatStatus;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@EnableBatchProcessing
@Configuration
public class JobConfig {

    private final Logger log = LoggerFactory.getLogger(JobConfig.class);

    private final StepBuilderFactory stepBuilderFactory;

    private final JobBuilderFactory jobBuilderFactory;

    public JobConfig(StepBuilderFactory stepBuilderFactory, JobBuilderFactory jobBuilderFactory) {
        this.stepBuilderFactory = stepBuilderFactory;
        this.jobBuilderFactory = jobBuilderFactory;
    }

    @Bean
    public Step step1() {
        return this.stepBuilderFactory.get("step1") //
            .tasklet((stepContribution, chunkContext) -> {
                log.info("Hello World!");
                return RepeatStatus.FINISHED;
            }) //
            .build();
    }

    @Bean
    public Job job1() {
        return this.jobBuilderFactory.get("job1") //
            .incrementer(new RunIdIncrementer()) //
            .start(step1()) //
            .build();
    }
}
EOF
```

ここで一つTipを。ローカル環境では普通にジョブを実行できるが、Cloud Foundry上ではコマンドライン引数に`--spring.batch.job.enabled=true`明示的につけないとジョブが実行されないようにします。これはこのアプリケーションがCloud Foundry上のLong Running Processとして起動してしまった時にジョブが実行されないようにするためにです。Cloud Foundry上ではTaskとして明示的に実行した時にのみジョブが実行されるようにします。

Cloud Foundry上では`cloud`プロファイルが有効になるため、`application-cloud.properties`に次の設定を行えば、Cloud Foundry上のみ`spring.batch.job.enabled`がデフォルトで`false`になります。ローカル環境では`--spring.profiles.active=cloud`を指定しない限りは無視されます。

```properties
cat <<EOF > src/main/resources/application-cloud.properties
spring.batch.job.enabled=false
EOF
```

次の設定は必須ではありませんが、以下の説明(ログのキャプチャ)ではこの設定でログ出力を減らしています。

```properties
cat <<EOF > src/main/resources/application.properties
logging.level.root=WARN
logging.level.com.example=INFO
logging.level.org.springframework.batch=INFO
spring.jmx.enabled=false
EOF
```

アプリケーションをビルドします。

```
./mvnw clean package -DskipTests=true
```

ローカル環境で実行します。

```
java -jar target/hello-spring-batch-0.0.1-SNAPSHOT.jar
```

![image](https://user-images.githubusercontent.com/106908/54089779-03e2a180-43b0-11e9-942d-937266807a0c.png)

まずは普通のSpring Batchアプリケーションを作りました。

### Cloud Foundry上でTaskとしてSpring Batchのジョブを実行する

次にこのアプリケーションをCloud Foundryにデプロイします。

```
cf push hello-batch -p target/hello-spring-batch-0.0.1-SNAPSHOT.jar -m 768m --health-check-type none --random-route && cf stop hello-batch
```

![image](https://user-images.githubusercontent.com/106908/54089349-65544180-43ab-11e9-87a0-99b9fc929cff.png)


```
$ cf curl /v3/apps/$(cf app hello-batch --guid)/droplets/current | jq -r .process_types.task
JAVA_OPTS="-agentpath:$PWD/.java-buildpack/open_jdk_jre/bin/jvmkill-1.16.0_RELEASE=printHeapHistogram=1 -Djava.io.tmpdir=$TMPDIR -XX:ActiveProcessorCount=$(nproc) -Djava.ext.dirs=$PWD/.java-buildpack/container_security_provider:$PWD/.java-buildpack/open_jdk_jre/lib/ext -Djava.security.properties=$PWD/.java-buildpack/java_security/java.security $JAVA_OPTS" && CALCULATED_MEMORY=$($PWD/.java-buildpack/open_jdk_jre/bin/java-buildpack-memory-calculator-3.13.0_RELEASE -totMemory=$MEMORY_LIMIT -loadedClasses=13479 -poolType=metaspace -stackThreads=250 -vmOptions="$JAVA_OPTS") && echo JVM Memory Configuration: $CALCULATED_MEMORY && JAVA_OPTS="$JAVA_OPTS $CALCULATED_MEMORY" && MALLOC_ARENA_MAX=2 SERVER_PORT=$PORT eval exec $PWD/.java-buildpack/open_jdk_jre/bin/java $JAVA_OPTS -cp $PWD/. org.springframework.boot.loader.JarLauncher
```

```
cf run-task hello-batch "$(cf curl /v3/apps/$(cf app hello-batch --guid)/droplets/current | jq -r .process_types.task) --spring.batch.job.enabled=true"
```

![image](https://user-images.githubusercontent.com/106908/54089325-363dd000-43ab-11e9-9c73-e9e27d9a2b0e.png)


Taskの実行履歴は`cf tasks`で確認できます。

```
cf tasks hello-batch
```

### Job実行履歴の永続化

```
cf create-service cleardb spark job-db
cf bind-service hello-batch job-db
cf restage hello-batch && cf stop hell-batch
```

![image](https://user-images.githubusercontent.com/106908/54089634-591db380-43ae-11e9-9168-a46ab393ce88.png)


![image](https://user-images.githubusercontent.com/106908/54089657-9aae5e80-43ae-11e9-8d59-d75710045ff8.png)

### Scheduler for PCFを利用してTaskを定期実行する

https://docs.pivotal.io/pcf-scheduler/1-2/using-jobs.html

```
$ cf marketplace | grep scheduler
scheduler-for-pcf             standard  
```

```
cf create-service scheduler-for-pcf standard hello-scheduler
cf bind-service hello-batch hello-scheduler
```

https://network.pivotal.io/products/p-scheduler

```
cf install-plugin ~/Downloads/scheduler-for-pcf-cliplugin-macosx64-binary-1.1.0 -f
```

```
cf create-job hello-batch hello-job "$(cf curl /v3/apps/$(cf app hello-batch --guid)/droplets/current | jq -r .process_types.task) --spring.batch.job.enabled=true"
```

```
cf jobs
```

![image](https://user-images.githubusercontent.com/106908/54089285-dcd5a100-43aa-11e9-8020-bc72a2ab9ca0.png)


```
cf run-job hello-job
```

![image](https://user-images.githubusercontent.com/106908/54089389-d0057d00-43ab-11e9-8e31-9d1c9a501c6c.png)

```
cf schedule-job hello-job "*/5 * ? * *"
```

```
cf job-schedules
```

![image](https://user-images.githubusercontent.com/106908/54089473-8a957f80-43ac-11e9-9d35-32796385afe5.png)


![image](https://user-images.githubusercontent.com/106908/54089501-cc262a80-43ac-11e9-9104-2279f708e287.png)


```
cf job-history hello-job
```

![image](https://user-images.githubusercontent.com/106908/54089606-06dc9280-43ae-11e9-9223-972c16366f63.png)

