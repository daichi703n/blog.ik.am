---
title: BOSH CLIを使ってSAN対応のTLS自己証明書を作成
tags: ["BOSH", "TLS"]
categories: ["Dev", "Infrastructure", "BOSH"]
date: 2017-10-31T00:36:07+09:00
---

Tipsです。

[BOSH CLI](https://bosh.io/docs/cli-v2.html#install)をインストールして、


次のscript(`gen.sh`)を作成。

``` bash
#!/bin/sh

set -e

cat <<'EOF' > dummy.yml
variables:
- name: default_ca
  type: certificate
  options:
    is_ca: true
    common_name: ca
- name: ssl
  type: certificate
  options:
    ca: default_ca
    common_name: ((domain))
    alternative_names: ((sans))
EOF


DOMAIN=$1
shift
SANS=$@

_SANS="["
for san in ${SANS};do
  _SANS="$_SANS '$san',"
done
_SANS="$_SANS]"

bosh int dummy.yml -v domain=${DOMAIN} -v sans="${_SANS}" --vars-store=creds.yml > /dev/null
bosh int creds.yml --path /ssl/ca > ca.crt
bosh int creds.yml --path /ssl/certificate > gen.crt
bosh int creds.yml --path /ssl/private_key > gen.key

openssl x509 -in gen.crt -text -noout

rm -f dummy.yml creds.yml
```

で実行。

```
chmod +x gen.sh
./gen.sh example.com *.example.com
```

次のファイルを得られます。

```
$ ls -la
total 24
drwxrwxr-x  2 maki maki 4096 Nov  6 13:07 .
drwxrwxrwt 10 root root 4096 Nov  6 13:07 ..
-rw-rw-r--  1 maki maki 1473 Nov  6 13:07 ca.crt
-rw-rw-r--  1 maki maki 1546 Nov  6 13:07 gen.crt
-rw-rw-r--  1 maki maki 2460 Nov  6 13:07 gen.key
-rwxrwxr-x  1 maki maki  680 Nov  6 13:04 gen.sh
```
