---
title: MicroPCFでローカルCloudFoundry環境を作る
tags: ["Cloud Foundry", "MicroPCF"]
categories: ["Service", "PaaS", "CloudFoundry"]
date: 2015-12-13T19:07:30+09:00
---

Cloud FoundryはオープンソースなPaaSプラットフォームであり、ローカルにもPaaS環境を構築することができます。


MicroPCFは開発用にローカル環境で簡単にCloud Foundryを試すための環境です。(MicroPCFとは？や、BOSH Liteとの違いは[こちらのissue](https://github.com/pivotal-cf/micropcf/issues/12)を参照してください)
`vagrant up`だけで、ローカルに簡単にCloudFoundry環境を作ることができます。

試したのは[v0.5.0](https://github.com/pivotal-cf/micropcf/releases/tag/v0.5.0)です。
また、VagrantとVirtualBoxのバージョンは以下の通りです。

``` console
$ vagrant --version
Vagrant 1.8.1
$ VBoxManage --version
5.0.12r104815
```

## セットアップ方法

``` bash
$ mkdir micropcf
$ cd micropcf
$ curl -L https://github.com/pivotal-cf/micropcf/releases/download/v0.5.0/Vagrantfile-v0.5.0.base -o Vagrantfile
```

設定可能な環境変数は以下の通りです。

* `MICROPCF_IP` ... MicroPCFのIPアドレス(デフォルトは`192.168.11.11`)
* `MICROPCF_DOMAIN` ... MicroPCFのドメイン名(デフォルトのIPアドレスを使う場合は`local.micropcf.io`、それ以外の場合は`$MICROPCF_IP.xip.io`)
* `VM_CORES` ... VMに割り当てるCPU数(デフォルトはホストマシンの論理コア数)
* `VM_MEMORY` ... VMに割り当てるメモリ(MB)(デフォルトはホストマシンの1/4のメモリ)

自分の環境は`192.168.11.*`をすでに使っていたので、`MICROPCF_IP`を設定しないと、

``` console
The specified host network collides with a non-hostonly network!
This will cause your specified IP to be inaccessible. Please change
the IP or name of your host only network so that it no longer matches that of
a bridged or non-hostonly network.
```

と言われ、以下の環境変数を設定しました。

``` console
$ export MICROPCF_IP=192.168.33.10
```

以上の設定の後、`vagrant up`します。boxのファイルサイズがかなり大きいので初回ダウンロードは時間がかかります。

``` console
$ vagrant up --provider virtualbox
Bringing machine 'default' up with 'virtualbox' provider...
==> default: Box 'micropcf/base' could not be found. Attempting to find and install...
    default: Box Provider: virtualbox
    default: Box Version: 0.34.0
==> default: Loading metadata for box 'micropcf/base'
    default: URL: https://atlas.hashicorp.com/micropcf/base
==> default: Adding box 'micropcf/base' (v0.34.0) for provider: virtualbox
    default: Downloading: https://atlas.hashicorp.com/micropcf/boxes/base/versions/0.34.0/providers/virtualbox.box
==> default: Successfully added box 'micropcf/base' (v0.34.0) for 'virtualbox'!
==> default: Importing base box 'micropcf/base'...
==> default: Matching MAC address for NAT networking...
==> default: Checking if box 'micropcf/base' is up to date...
==> default: Setting the name of the VM: micropcf_default_1454165581656_73411
==> default: Clearing any previously set network interfaces...
==> default: Preparing network interfaces based on configuration...
    default: Adapter 1: nat
    default: Adapter 2: hostonly
==> default: Forwarding ports...
    default: 22 (guest) => 2222 (host) (adapter 1)
==> default: Running 'pre-boot' VM customizations...
==> default: Booting VM...
==> default: Waiting for machine to boot. This may take a few minutes...
    default: SSH address: 127.0.0.1:2222
    default: SSH username: vagrant
    default: SSH auth method: private key
    default: 
    default: Vagrant insecure key detected. Vagrant will automatically replace
    default: this with a newly generated keypair for better security.
    default: 
    default: Inserting generated public key within guest...
    default: Removing insecure key from the guest if it's present...
    default: Key inserted! Disconnecting and reconnecting using new SSH key...
==> default: Machine booted and ready!
==> default: Checking for guest additions in VM...
==> default: Configuring and enabling network interfaces...
==> default: Running provisioner: shell...
    default: Running: inline script
==> default: stdin: is not a tty
==> default: Waiting for services to start...
==> default: MicroPCF is now running.
==> default: To begin using MicroPCF, please run:
==> default: 	cf api api.192.168.33.10.xip.io --skip-ssl-validation
==> default: 	cf login
==> default: Email: admin
==> default: Password: admin
```

あっさり立ち上がりました！

## アプリケーションをデプロイ

まずはログインします。ユーザー名、パスワードともに`admin`です。

``` bash
$ cf login -a api.192.168.33.10.xip.io -u admin -p admin --skip-ssl-validation
API endpoint: api.192.168.33.10.xip.io
Authenticating...
OK

Targeted org 192.168.33.10.xip.io-org


                   
API endpoint:   https://api.192.168.33.10.xip.io (API version: 2.44.0)   
User:           admin   
Org:            micropcf-org   
Space:          micropcf-space 
```

[前に書いた入門記事](https://blog.ik.am/entries/359)と同じく`hello-pws`をpushします。

``` bash
$ git clone https://github.com/making/hello-pws
$ cd hello-pws
$ mvn clean package
$ cf push hello-pws -p target/hello-pws.jar -m 256m
Creating app hello-pws in org micropcf-org / space micropcf-space as admin...
OK

Creating route hello-pws.192.168.33.10.xip.io...
OK

Binding hello-pws.192.168.33.10.xip.io to hello-pws...
OK

Uploading hello-pws...
Uploading app files from: target/hello-pws.jar
Uploading 13.2M, 109 files
Done uploading               
OK

Starting app hello-pws in org micropcf-org / space micropcf-space as admin...
Downloading java_buildpack...
Downloading ruby_buildpack...
Downloading nodejs_buildpack...
Downloading go_buildpack...
Downloading python_buildpack...
Downloading binary_buildpack...
Downloading php_buildpack...
Downloading staticfile_buildpack...
Downloaded binary_buildpack (8.3K)
Downloaded staticfile_buildpack (2.4M)
Downloaded nodejs_buildpack (56.7M)
Downloaded java_buildpack (239.9M)
Downloaded ruby_buildpack (269.1M)
Downloaded python_buildpack (254M)
Downloaded go_buildpack (342.6M)
Downloaded php_buildpack (324.9M)
Creating container
Successfully created container
Downloading app package...
Downloaded app package (11.7M)
Staging...
-----> Java Buildpack Version: v3.4 (offline) | https://github.com/cloudfoundry/java-buildpack.git#5cb22f2
-----> Downloading Open Jdk JRE 1.8.0_65 from https://download.run.pivotal.io/openjdk/trusty/x86_64/openjdk-1.8.0_65.tar.gz (found in cache)
       Expanding Open Jdk JRE to .java-buildpack/open_jdk_jre (2.5s)
-----> Downloading Open JDK Like Memory Calculator 2.0.1_RELEASE from https://download.run.pivotal.io/memory-calculator/trusty/x86_64/memory-calculator-2.0.1_RELEASE.tar.gz (found in cache)
       Memory Settings: -Xms160M -XX:MetaspaceSize=64M -XX:MaxMetaspaceSize=64M -Xss853K -Xmx160M
-----> Downloading Spring Auto Reconfiguration 1.10.0_RELEASE from https://download.run.pivotal.io/auto-reconfiguration/auto-reconfiguration-1.10.0_RELEASE.jar (found in cache)
Exit status 0
Staging complete
Uploading droplet, build artifacts cache...
Uploading droplet...
Uploading build artifacts cache...
Uploaded build artifacts cache (108B)
Uploaded droplet (56.7M)
Uploading complete

0 of 1 instances running, 1 starting
0 of 1 instances running, 1 starting
0 of 1 instances running, 1 starting
0 of 1 instances running, 1 starting
0 of 1 instances running, 1 starting
0 of 1 instances running, 1 starting
0 of 1 instances running, 1 starting
1 of 1 instances running

App started


OK

App hello-pws was started using this command `CALCULATED_MEMORY=$($PWD/.java-buildpack/open_jdk_jre/bin/java-buildpack-memory-calculator-2.0.1_RELEASE -memorySizes=metaspace:64m.. -memoryWeights=heap:75,metaspace:10,native:10,stack:5 -memoryInitials=heap:100%,metaspace:100% -totMemory=$MEMORY_LIMIT) && JAVA_OPTS="-Djava.io.tmpdir=$TMPDIR -XX:OnOutOfMemoryError=$PWD/.java-buildpack/open_jdk_jre/bin/killjava.sh $CALCULATED_MEMORY" && SERVER_PORT=$PORT eval exec $PWD/.java-buildpack/open_jdk_jre/bin/java $JAVA_OPTS -cp $PWD/.:$PWD/.java-buildpack/spring_auto_reconfiguration/spring_auto_reconfiguration-1.10.0_RELEASE.jar org.springframework.boot.loader.JarLauncher`

Showing health and status for app hello-pws in org micropcf-org / space micropcf-space as admin...
OK

requested state: started
instances: 1/1
usage: 256M x 1 instances
urls: hello-pws.192.168.33.10.xip.io
last uploaded: Sat Jan 30 15:10:27 UTC 2016
stack: cflinuxfs2
buildpack: java-buildpack=v3.4-offline-https://github.com/cloudfoundry/java-buildpack.git#5cb22f2 java-main open-jdk-like-jre=1.8.0_65 open-jdk-like-memory-calculator=2.0.1_RELEASE spring-auto-reconfiguration=1.10.0_RELEASE

     state     since                    cpu    memory           disk           details   
#0   running   2016-01-31 12:14:20 AM   0.0%   135.4M of 256M   136.2M of 1G 
```

デプロイできました。

``` bash
$ curl hello-pws.192.168.33.10.xip.io
Hello from 192.168.33.10:60002
```

スケールアウトも[前記事](https://blog.ik.am/entries/359)と同じようにできます。

ローカルでCloud Foundryを色々試したい場合に便利なようです。

ただし、管理コンソールはありません。またマーケットプレイスにサービスが登録されていないのでマニュアルで登録する必要があるようです。

``` bash
$ cf marketplace
Getting services from marketplace in org maki-org / space development as admin...
OK

No service offerings found
```

[masterブランチ](https://github.com/pivotal-cf/micropcf/blob/master/images/micropcf/post-run)にはMySQLとRedisのサービスブローカーが含まれているので、もうすぐ使えるようになるはずです。期待。
