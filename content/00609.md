---
title: Cloud Native Buildpacks Tutorial - 8. Cloud Native BuildpacksでビルドしたOCIイメージをデプロイする
tags: ["Cloud Native Buildpacks Tutorial", "Cloud Native Buildpacks", "Spring Boot", "Series"]
categories: ["Dev", "Infrastructure", "CloudNativeBuildpacks", "SpringBoot"]
---

Cloud Native BuildpacksでビルドしたOCIイメージをデプロイしてみます。

デプロイ先は

* [Cloud Foundry (Pivotal Web Services)](/entries/610) 
* [Cloud Run](/entries/611)
* 他、追加予定

デプロイするアプリケーションはJava(Spring Boot)とします。

次のコマンドでイメージを作成し、Docker Hubにpushします。

```
export DOCKERHUB_USERNAME=****
export DOCKERHUB_PASSWORD=****
docker login -u ${DOCKERHUB_USERNAME} -p ${DOCKERHUB_PASSWORD}

curl https://start.spring.io/starter.tgz \
       -d artifactId=hello-cnb \
       -d baseDir=hello-cnb \
       -d dependencies=webflux,actuator \
       -d packageName=hello \
       -d applicationName=HelloCnbApplication | tar -xzvf -
cd hello-cnb

pack build ${DOCKERHUB_USERNAME}/hello-cnb \
  --no-pull \
  --builder gcr.io/paketo-buildpacks/builder:base \
  --publish
```

作成したイメージをまずはローカルで起動します。

```
docker run --rm -p 8080:8080 -e INFO_MESSAGE='Hello World!' ${DOCKERHUB_USERNAME}/hello-cnb
```

起動時に次のようなログが出力されます。

```
Container memory limit unset. Configuring JVM for 1G container.
Calculated JVM Memory Configuration: -XX:MaxDirectMemorySize=10M -XX:MaxMetaspaceSize=86636K -XX:ReservedCodeCacheSize=240M -Xss1M -Xmx449939K (Head Room: 0%, Loaded Class Count: 12882, Thread Count: 250, Total Memory: 1073741824)

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::             (v2.3.0.M4)

2020-04-28 14:19:53.106  WARN 1 --- [           main] pertySourceApplicationContextInitializer : Skipping 'cloud' property source addition because not in a cloud
2020-04-28 14:19:53.112  WARN 1 --- [           main] nfigurationApplicationContextInitializer : Skipping reconfiguration because not in a cloud
2020-04-28 14:19:53.122  INFO 1 --- [           main] hello.HelloCnbApplication                : Starting HelloCnbApplication on 9b02b1379b51 with PID 1 (/workspace/BOOT-INF/classes started by cnb in /workspace)
2020-04-28 14:19:53.124  INFO 1 --- [           main] hello.HelloCnbApplication                : No active profile set, falling back to default profiles: default
2020-04-28 14:19:54.757  INFO 1 --- [           main] o.s.b.a.e.web.EndpointLinksResolver      : Exposing 2 endpoint(s) beneath base path '/actuator'
2020-04-28 14:19:55.450  INFO 1 --- [           main] o.s.b.web.embedded.netty.NettyWebServer  : Netty started on port(s): 8080
2020-04-28 14:19:55.455  INFO 1 --- [           main] hello.HelloCnbApplication                : Started HelloCnbApplication in 2.874 seconds (JVM running for 3.687)
```

JVMのメモリが自動で設定されていることに注目してください。

アプリケーションにアクセスします。

```
$ curl localhost:8080/actuator/health -w '\n'
{"status":"UP"}

$ curl localhost:8080/actuator/info -w '\n'
{"message":"Hello World!"}
```