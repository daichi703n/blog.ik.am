---
title: ytt(YAML Template Tool)入門 - Overlay編
tags: ["YAML", "ytt"]
categories: ["Dev", "ytt"]
---

* https://get-ytt.io
* https://github.com/k14s/ytt/blob/develop/docs/lang-ref-ytt-overlay.md

**目次**
<!-- toc -->

### Mapの操作

#### Mapの値変更

```yaml
#! deployment.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: demo
  template:
    metadata:
      labels:
        app: demo
    spec:
      containers:
      - image: making/hello-cnb
        name: hello-cnb
---
apiVersion: v1
kind: Service
metadata:
  name: demo
spec:
  ports:
  - name: 80-8080
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: demo
  type: LoadBalancer
```

```yaml
#! scale.yml
#@ load("@ytt:overlay", "overlay")

#@overlay/match by=overlay.subset({"kind":"Deployment", "metadata": {"name": "demo"}})
---
spec:
  replicas: 3
```

```
$ ytt -f deployment.yml -f scale.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo
spec:
  replicas: 3
  selector:
    matchLabels:
      app: demo
  template:
    metadata:
      labels:
        app: demo
    spec:
      containers:
      - image: making/hello-cnb
        name: hello-cnb
---
apiVersion: v1
kind: Service
metadata:
  name: demo
spec:
  ports:
  - name: 80-8080
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: demo
  type: LoadBalancer
```

```yaml
#! nodeport.yml
#@ load("@ytt:overlay", "overlay")

#@overlay/match by=overlay.subset({"kind":"Service", "metadata": {"name": "demo"}})
---
spec:
  type: NodePort
```

```
$ ytt -f deployment.yml -f nodeport.yml             
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: demo
  template:
    metadata:
      labels:
        app: demo
    spec:
      containers:
      - image: making/hello-cnb
        name: hello-cnb
---
apiVersion: v1
kind: Service
metadata:
  name: demo
spec:
  ports:
  - name: 80-8080
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: demo
  type: NodePort
```

```
$ ytt -f deployment.yml -f scale.yml -f nodeport.yml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo
spec:
  replicas: 3
  selector:
    matchLabels:
      app: demo
  template:
    metadata:
      labels:
        app: demo
    spec:
      containers:
      - image: making/hello-cnb
        name: hello-cnb
---
apiVersion: v1
kind: Service
metadata:
  name: demo
spec:
  ports:
  - name: 80-8080
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: demo
  type: NodePort
```

#### Mapの値追加

```yaml
#! prometheus-annotation.yml
#@ load("@ytt:overlay", "overlay")

#@overlay/match by=overlay.subset({"kind":"Deployment", "metadata": {"name": "demo"}})
---
spec:
  template:
    metadata:
      #@overlay/match missing_ok=True
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
```

```
$ ytt -f deployment.yml -f prometheus-annotation.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: demo
  template:
    metadata:
      labels:
        app: demo
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
    spec:
      containers:
      - image: making/hello-cnb
        name: hello-cnb
---
apiVersion: v1
kind: Service
metadata:
  name: demo
spec:
  ports:
  - name: 80-8080
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: demo
  type: LoadBalancer
```


```yaml
#! namespace.yml
#@ load("@ytt:overlay", "overlay")

#@overlay/match by=overlay.all, expects="1+"
---
metadata:
  #@overlay/match missing_ok=True
  namespace: demo
```

```
$ ytt -f deployment.yml -f namespace.yml            
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo
  namespace: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: demo
  template:
    metadata:
      labels:
        app: demo
    spec:
      containers:
      - image: making/hello-cnb
        name: hello-cnb
---
apiVersion: v1
kind: Service
metadata:
  name: demo
  namespace: demo
spec:
  ports:
  - name: 80-8080
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: demo
  type: LoadBalancer
```


```yaml
#! namespace.yml
#@ load("@ytt:overlay", "overlay")
apiVersion: v1
kind: Namespace
metadata:
  name: demo
#@overlay/match by=overlay.all, expects="1+"
---
metadata:
  #@overlay/match missing_ok=True
  namespace: demo
```

```
$ ytt -f deployment.yml -f namespace.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo
  namespace: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: demo
  template:
    metadata:
      labels:
        app: demo
    spec:
      containers:
      - image: making/hello-cnb
        name: hello-cnb
---
apiVersion: v1
kind: Service
metadata:
  name: demo
  namespace: demo
spec:
  ports:
  - name: 80-8080
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: demo
  type: LoadBalancer
---
apiVersion: v1
kind: Namespace
metadata:
  name: demo
  namespace: demo
```

```yaml
#! namespace.yml
#@ load("@ytt:overlay", "overlay")
apiVersion: v1
kind: Namespace
metadata:
  name: demo
#@overlay/match by=overlay.not_op(overlay.subset({"kind": "Namespace"})), expects="1+"
---
metadata:
  #@overlay/match missing_ok=True
  namespace: demo
```

```
$ ytt -f deployment.yml -f namespace.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo
  namespace: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: demo
  template:
    metadata:
      labels:
        app: demo
    spec:
      containers:
      - image: making/hello-cnb
        name: hello-cnb
---
apiVersion: v1
kind: Service
metadata:
  name: demo
  namespace: demo
spec:
  ports:
  - name: 80-8080
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: demo
  type: LoadBalancer
---
apiVersion: v1
kind: Namespace
metadata:
  name: demo
```

#### Mapの値削除

```yaml
#! remove-service-type.yml
#@ load("@ytt:overlay", "overlay")

#@overlay/match by=overlay.subset({"kind":"Service", "metadata": {"name": "demo"}})
---
spec:
  #@overlay/remove
  type: 
```

```
$ ytt -f deployment.yml -f remove-service-type.yml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: demo
  template:
    metadata:
      labels:
        app: demo
    spec:
      containers:
      - image: making/hello-cnb
        name: hello-cnb
---
apiVersion: v1
kind: Service
metadata:
  name: demo
spec:
  ports:
  - name: 80-8080
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: demo
```

### List内のMap値の操作

```
#! change-image.yml

#@ load("@ytt:overlay", "overlay")

#@overlay/match by=overlay.subset({"kind":"Deployment", "metadata": {"name": "demo"}})
---
spec:
  template:
    spec:
      containers:
      #@overlay/match by="name"
      - name: hello-cnb
        image: harbor.example.com/demo/hello-cnb
```


```
$ ytt -f deployment.yml -f change-image.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: demo
  template:
    metadata:
      labels:
        app: demo
    spec:
      containers:
      - image: harbor.example.com/demo/hello-cnb
        name: hello-cnb
---
apiVersion: v1
kind: Service
metadata:
  name: demo
spec:
  ports:
  - name: 80-8080
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: demo
  type: LoadBalancer
```

```yaml
#! demo-env.yml

#@ load("@ytt:overlay", "overlay")

#@overlay/match by=overlay.subset({"kind":"Deployment", "metadata": {"name": "demo"}})
---
spec:
  template:
    spec:
      containers:
      #@overlay/match by="name"
      - name: hello-cnb
        #@overlay/match missing_ok=True
        env:
        - name: INFO_MESSAGE
          value: "Hello World!"
```

```
$ ytt -f deployment.yml -f demo-env.yml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: demo
  template:
    metadata:
      labels:
        app: demo
    spec:
      containers:
      - image: making/hello-cnb
        name: hello-cnb
        env:
        - name: INFO_MESSAGE
          value: Hello World!
---
apiVersion: v1
kind: Service
metadata:
  name: demo
spec:
  ports:
  - name: 80-8080
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: demo
  type: LoadBalancer
```


```yaml
#! sidecar.yml

#@ load("@ytt:overlay", "overlay")

#@overlay/match by=overlay.subset({"kind":"Deployment", "metadata": {"name": "demo"}})
---
spec:
  template:
    spec:
      containers:
      #@overlay/match by="name" missing_ok=True
      - name: hello-sidecar
        image: busybox
        command: ['sh', '-c', 'echo Hello YTT! && sleep 3600']
```

```
$ ytt -f deployment.yml -f sidecar.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: demo
  template:
    metadata:
      labels:
        app: demo
    spec:
      containers:
      - image: making/hello-cnb
        name: hello-cnb
      - name: hello-sidecar
        image: busybox
        command:
        - sh
        - -c
        - echo Hello YTT! && sleep 3600
---
apiVersion: v1
kind: Service
metadata:
  name: demo
spec:
  ports:
  - name: 80-8080
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: demo
  type: LoadBalancer
```

### Listの操作

#### Listの値変更

```yaml
#! manifest.yml
applications:
- name: hello
  memory: 1g
  path: hello.jar
  buildpacks:
  - java_buildpack
```

```yaml
#! replace-buildpack.yml
#@ load("@ytt:overlay", "overlay")

#@overlay/match by=overlay.all
---
applications:
#@overlay/match by=overlay.all
- buildpacks:
  #@overlay/match by=overlay.subset("java_buildpack")
  #@overlay/replace
  - java_buildpack_offline
```

```
$ ytt -f manifest.yml -f replace-buildpack.yml
applications:
- name: hello
  memory: 1g
  path: hello.jar
  buildpacks:
  - java_buildpack_offline
```


#### Listの値追加

```yaml
#! insert-buildpack.yml
#@ load("@ytt:overlay", "overlay")

#@overlay/match by=overlay.all
---
applications:
#@overlay/match by=overlay.all
- buildpacks:
  #@overlay/match by=overlay.index(0)
  #@overlay/insert before=True
  - datadog_buildpack
```

```
$ ytt -f manifest.yml -f insert-buildpack.yml
applications:
- name: hello
  memory: 1g
  path: hello.jar
  buildpacks:
  - datadog_buildpack
  - java_buildpack
```

#### Listの値削除

```yaml
#! remove-buildpack.yml
#@ load("@ytt:overlay", "overlay")

#@overlay/match by=overlay.all
---
applications:
#@overlay/match by=overlay.all
- buildpacks:
  #@overlay/match by=overlay.subset("java_buildpack")
  #@overlay/remove
  -
```


```
$ ytt -f manifest.yml -f remove-buildpack.yml
applications:
- name: hello
  memory: 1g
  path: hello.jar
  buildpacks: []
```