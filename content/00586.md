---
title: Cloud Native Buildpacks Tutorial - 2.2. ┝ gcr.io/paketo-buildpacks/builder:base BuilderでJavaアプリ(Servlet)のOCIイメージを作成
tags: ["Cloud Native Buildpacks Tutorial", "Cloud Native Buildpacks", "Paketo", "Series"]
categories: ["Dev", "Infrastructure", "CloudNativeBuildpacks", "Paketo"]
---

`gcr.io/paketo-buildpacks/builder:base`でJava(Servlet)のアプリケーションのOCIイメージを作成します。

BuilderとStackを予めpullしておいてください。

```
docker pull gcr.io/paketo-buildpacks/builder:base
docker pull gcr.io/paketo-buildpacks/run:base-cnb
```

次のコマンドで"Hello World"アプリケーションを作成します。

```
mkdir -p hello-servlet/src/main/java/hello
cd hello-servlet
cat <<'EOF' > src/main/java/hello/HelloServlet.java
package hello;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@WebServlet(name = "hello", urlPatterns = "/")
public class HelloServlet extends HttpServlet {
	@Override
	protected void doGet(HttpServletRequest req, HttpServletResponse res)
			throws ServletException, IOException {
		res.setContentType("text/plain;charset=utf-8");
		PrintWriter pw = res.getWriter();
		pw.print("Hello World!");
		pw.flush();
	}
}
EOF
cat <<'EOF' > pom.xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>hello</groupId>
    <artifactId>hello-servlet</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <packaging>war</packaging>

    <properties>
        <maven.compiler.source>11</maven.compiler.source>
        <maven.compiler.target>11</maven.compiler.target>
        <failOnMissingWebXml>false</failOnMissingWebXml>
    </properties>

    <dependencies>
        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>javax.servlet-api</artifactId>
            <version>4.0.1</version>
            <scope>provided</scope>
        </dependency>
    </dependencies>
</project>
EOF
```

`pack build`コマンドでイメージを作成します。

Javaの場合はソースからビルドする方法とjar/warファイルからビルドする方法があります。

### ソースからビルドする場合

```
pack build making/pack-servlet --no-pull --builder gcr.io/paketo-buildpacks/builder:base
```

> BuilderとStackを事前にpullしていない場合は`--no-pull`を外せば、ビルド時にBuilderとStackもpullしますが、ビルドが遅くなります。

次のようなログが出力されます。

```
===> DETECTING
[detector] 6 of 11 buildpacks participating
[detector] paketo-buildpacks/bellsoft-liberica 2.3.1
[detector] paketo-buildpacks/build-system      1.2.0
[detector] paketo-buildpacks/executable-jar    1.2.1
[detector] paketo-buildpacks/apache-tomcat     1.1.1
[detector] paketo-buildpacks/spring-boot       1.5.1
[detector] paketo-buildpacks/dist-zip          1.2.1
===> ANALYZING
[analyzer] Previous image with name "index.docker.io/making/pack-servlet:latest" not found
===> RESTORING
===> BUILDING
[builder] 
[builder] Paketo BellSoft Liberica Buildpack 2.3.1
[builder]     Set $BP_JAVA_VERSION to configure the Java version. Default 11.*.
[builder]     Set $BPL_HEAD_ROOM to configure the headroom in memory calculation. Default 0.
[builder]     Set $BPL_LOADED_CLASS_COUNT to configure the number of loaded classes in memory calculation. Default 35% of classes.
[builder]     Set $BPL_THREAD_COUNT to configure the number of threads in memory calculation. Default 250.
[builder]   BellSoft Liberica JDK 11.0.7: Contributing to layer
[builder]     Downloading from https://github.com/bell-sw/Liberica/releases/download/11.0.7+10/bellsoft-jdk11.0.7+10-linux-amd64.tar.gz
[builder]     Verifying checksum
[builder]     Expanding to /layers/paketo-buildpacks_bellsoft-liberica/jdk
[builder]     Writing env.build/JAVA_HOME.override
[builder]     Writing env.build/JDK_HOME.override
[builder]   BellSoft Liberica JRE 11.0.7: Contributing to layer
[builder]     Downloading from https://github.com/bell-sw/Liberica/releases/download/11.0.7+10/bellsoft-jre11.0.7+10-linux-amd64.tar.gz
[builder]     Verifying checksum
[builder]     Expanding to /layers/paketo-buildpacks_bellsoft-liberica/jre
[builder]     Writing env/JAVA_HOME.override
[builder]     Writing env/MALLOC_ARENA_MAX.override
[builder]     Writing profile.d/active-processor-count.sh
[builder]   JVMKill Agent 1.16.0: Contributing to layer
[builder]     Downloading from https://github.com/cloudfoundry/jvmkill/releases/download/v1.16.0.RELEASE/jvmkill-1.16.0-RELEASE.so
[builder]     Verifying checksum
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/jvmkill
[builder]     Writing env/JAVA_OPTS.append
[builder]   Link-Local DNS: Contributing to layer
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/link-local-dns
[builder]     Writing profile.d/link-local-dns.sh
[builder]   Memory Calculator 4.0.0: Contributing to layer
[builder]     Downloading from https://github.com/cloudfoundry/java-buildpack-memory-calculator/releases/download/v4.0.0/memory-calculator-4.0.0.tgz
[builder]     Verifying checksum
[builder]     Expanding to /layers/paketo-buildpacks_bellsoft-liberica/memory-calculator
[builder]     Writing profile.d/memory-calculator.sh
[builder]   Class Counter: Contributing to layer
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/class-counter
[builder]   Java Security Properties: Contributing to layer
[builder]     Writing env.launch/JAVA_OPTS.append
[builder]     Writing env.launch/JAVA_SECURITY_PROPERTIES.override
[builder]   Security Providers Configurer: Contributing to layer
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/security-providers-configurer
[builder]     Writing profile.d/security-providers-classpath.sh
[builder]     Writing profile.d/security-providers-configurer.sh
[builder] 
[builder] Paketo Build System Buildpack 1.2.0
[builder]     Set $BP_BUILD_ARGUMENTS to configure the arguments passed to the build system. Default -Dmaven.test.skip=true package.
[builder]     Set $BP_BUILT_MODULE to configure the module to find application artifact in. Default <ROOT>.
[builder]     Set $BP_BUILT_ARTIFACT to configure the built application artifact. Default target/*.[jw]ar.
[builder]   Apache Maven 3.6.3: Contributing to layer
[builder]     Downloading from https://repo1.maven.org/maven2/org/apache/maven/apache-maven/3.6.3/apache-maven-3.6.3-bin.tar.gz
[builder]     Verifying checksum
[builder]     Expanding to /layers/paketo-buildpacks_build-system/maven
[builder]     Creating cache directory /home/cnb/.m2
[builder]   Compiled Application: Contributing to layer
[builder]     Executing mvn -Dmaven.test.skip=true package
[builder] [INFO] Scanning for projects...
[builder] [INFO] 
[builder] [INFO] ------------------------< hello:hello-servlet >-------------------------
[builder] [INFO] Building hello-servlet 0.0.1-SNAPSHOT
[builder] [INFO] --------------------------------[ war ]---------------------------------
[builder] Downloading from central: https://repo.maven.apache.org/maven2/org/apache/maven/plugins/maven-resources-plugin/2.6/maven-resources-plugin-2.6.pom
Downloaded from central: https://repo.maven.apache.org/maven2/org/apache/maven/plugins/maven-resources-plugin/2.6/maven-resources-plugin-2.6.pom (8.1 kB at 7.2 kB/s)
[builder] Downloading from central: https://repo.maven.apache.org/maven2/org/apache/maven/plugins/maven-plugins/23/maven-plugins-23.pom
Downloaded from central: https://repo.maven.apache.org/maven2/org/apache/maven/plugins/maven-plugins/23/maven-plugins-23.pom (9.2 kB at 28 kB/s)
[builder] Downloading from central: https://repo.maven.apache.org/maven2/org/apache/maven/maven-parent/22/maven-parent-22.pom
(途中略)
[builder] [INFO] Packaging webapp
[builder] [INFO] Assembling webapp [hello-servlet] in [/workspace/target/hello-servlet-0.0.1-SNAPSHOT]
[builder] [INFO] Processing war project
[builder] [INFO] Webapp assembled in [-7 msecs]
[builder] [INFO] Building war: /workspace/target/hello-servlet-0.0.1-SNAPSHOT.war
[builder] [INFO] ------------------------------------------------------------------------
[builder] [INFO] BUILD SUCCESS
[builder] [INFO] ------------------------------------------------------------------------
[builder] [INFO] Total time:  01:11 min
[builder] [INFO] Finished at: 2020-04-28T11:02:14Z
[builder] [INFO] ------------------------------------------------------------------------
[builder]   Removing source code
[builder] 
[builder] Paketo Apache Tomcat Buildpack 1.1.1
[builder]     Set $BP_TOMCAT_CONTEXT_PATH to configure the application context path. Default ROOT.
[builder]     Set $BP_TOMCAT_EXT_CONF_SHA256 to configure the SHA256 hash of the external Tomcat configuration archive. Default <none>.
[builder]     Set $BP_TOMCAT_EXT_CONF_STRIP to configure the number of directory components to strip from the external Tomcat configuration archive. Default 0.
[builder]     Set $BP_TOMCAT_EXT_CONF_URI to configure the download location of the external Tomcat configuration. Default <none>.
[builder]     Set $BP_TOMCAT_EXT_CONF_VERSION to configure the version of the external Tomcat configuration. Default <none>.
[builder]     Set $BP_TOMCAT_VERSION to configure the Tomcat version. Default 9.*.
[builder]     Set $BPL_TOMCAT_ACCESS_LOGGING to configure the Tomcat access logging state. Default disabled.
[builder]   Apache Tomcat 9.0.34: Contributing to layer
[builder]     Downloading from https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.34/bin/apache-tomcat-9.0.34.tar.gz
[builder]     Verifying checksum
[builder]     Expanding to /layers/paketo-buildpacks_apache-tomcat/catalina-home
[builder]     Writing env.launch/CATALINA_HOME.override
[builder]   Apache Tomcat Support: Contributing to layer
[builder]     Copying context.xml to /layers/paketo-buildpacks_apache-tomcat/catalina-base/conf
[builder]     Copying logging.properties to /layers/paketo-buildpacks_apache-tomcat/catalina-base/conf
[builder]     Copying server.xml to /layers/paketo-buildpacks_apache-tomcat/catalina-base/conf
[builder]     Copying web.xml to /layers/paketo-buildpacks_apache-tomcat/catalina-base/conf
[builder]   Apache Tomcat Access Logging Support 3.3.0
[builder]     Downloading from https://repo.spring.io/release/org/cloudfoundry/tomcat-access-logging-support/3.3.0.RELEASE/tomcat-access-logging-support-3.3.0.RELEASE.jar
[builder]     Verifying checksum
[builder]     Copying to /layers/paketo-buildpacks_apache-tomcat/catalina-base/lib
[builder]   Apache Tomcat Lifecycle Support 3.3.0
[builder]     Downloading from https://repo.spring.io/release/org/cloudfoundry/tomcat-lifecycle-support/3.3.0.RELEASE/tomcat-lifecycle-support-3.3.0.RELEASE.jar
[builder]     Verifying checksum
[builder]     Copying to /layers/paketo-buildpacks_apache-tomcat/catalina-base/lib
[builder]   Apache Tomcat Logging Support 3.3.0
[builder]     Downloading from https://repo.spring.io/release/org/cloudfoundry/tomcat-logging-support/3.3.0.RELEASE/tomcat-logging-support-3.3.0.RELEASE.jar
[builder]     Verifying checksum
[builder]     Copying to /layers/paketo-buildpacks_apache-tomcat/catalina-base/bin
[builder]     Writing /layers/paketo-buildpacks_apache-tomcat/catalina-base/bin/setenv.sh
[builder]   Mounting application at ROOT
[builder]     Writing env.launch/CATALINA_BASE.override
[builder]     Writing profile.d/access-logging-support.sh
[builder]   Process types:
[builder]     task:   catalina.sh run
[builder]     tomcat: catalina.sh run
[builder]     web:    catalina.sh run
===> EXPORTING
[exporter] Adding layer 'launcher'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:class-counter'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:java-security-properties'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:jre'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:jvmkill'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:link-local-dns'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:memory-calculator'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:security-providers-configurer'
[exporter] Adding layer 'paketo-buildpacks/apache-tomcat:catalina-base'
[exporter] Adding layer 'paketo-buildpacks/apache-tomcat:catalina-home'
[exporter] Adding 1/1 app layer(s)
[exporter] Adding layer 'config'
[exporter] *** Images (d514554af918):
[exporter]       index.docker.io/making/pack-servlet:latest
[exporter] Adding cache layer 'paketo-buildpacks/bellsoft-liberica:jdk'
[exporter] Adding cache layer 'paketo-buildpacks/build-system:application'
[exporter] Adding cache layer 'paketo-buildpacks/build-system:cache'
[exporter] Adding cache layer 'paketo-buildpacks/build-system:maven'
Successfully built image making/pack-servlet
```

> `pack build`時に`--publish`オプションをつけると、Docker Registryでのpushを行います。事前に`docker login`が必要です。

Mavenによるソースコードから始まるため、初回ビルド時には依存ライブラリのダウンロードが始まります。
依存ライブラリはキャッシュされ、二回目以降はキャッシュが使用されます。

> * JDKのバージョンはビルド時に[環境変数`BP_JAVA_VERSION`を設定](https://github.com/paketo-buildpacks/bellsoft-liberica#configuration)することで指定できます。デフォルトは`11.*`です。(例: `-e BP_JAVA_VERSION=8.*`)
> * Tomcatのバージョンはビルド時に[環境変数`BP_TOMCAT_VERSION`を設定](https://github.com/paketo-buildpacks/apache-tomcat#configuration)することで指定できます。デフォルトは`9.*`です。(例: `-e BP_TOMCAT_VERSION=8.5.*`)

`pack inspect-image`でイメージを解析します。

```
$ pack inspect-image making/pack-servlet
Inspecting image: making/pack-servlet

REMOTE:
(not present)

LOCAL:

Stack: io.buildpacks.stacks.bionic

Base Image:
  Reference: 40845d52d6fb6d285a320aeac821b61cff0e2863e0ff12e12138c4775aae1828
  Top Layer: sha256:f0d87426c0a82340475d73a9108b063d3d3cfbd92ef3b4af74dcd8f904475a36

Run Images:
  gcr.io/paketo-buildpacks/run:base-cnb

Buildpacks:
  ID                                         VERSION
  paketo-buildpacks/bellsoft-liberica        2.3.1
  paketo-buildpacks/build-system             1.2.0
  paketo-buildpacks/executable-jar           1.2.1
  paketo-buildpacks/apache-tomcat            1.1.1
  paketo-buildpacks/spring-boot              1.5.1
  paketo-buildpacks/dist-zip                 1.2.1

Processes:
  TYPE                 SHELL        COMMAND                ARGS
  web (default)        bash         catalina.sh run        
  task                 bash         catalina.sh run        
  tomcat               bash         catalina.sh run    
```

Maven以外にもGradleによるビルドもサポートされています。

### warからビルドする場合

まずはソースコードをビルドしてwarファイルを作成します。

```
mvn -Dmaven.test.skip=true clean package
```

`pack build`の`-p`オプションで作成したwarファイルのパスを指定します。

```
pack build making/pack-servlet --no-pull -p target/hello-servlet-0.0.1-SNAPSHOT.war --builder gcr.io/paketo-buildpacks/builder:base
```

次のようなログが出力されます。

```
===> DETECTING
[detector] 4 of 11 buildpacks participating
[detector] paketo-buildpacks/bellsoft-liberica 2.3.1
[detector] paketo-buildpacks/apache-tomcat     1.1.1
[detector] paketo-buildpacks/spring-boot       1.5.1
[detector] paketo-buildpacks/dist-zip          1.2.1
===> ANALYZING
[analyzer] Previous image with name "index.docker.io/making/pack-servlet:latest" not found
===> RESTORING
===> BUILDING
[builder] 
[builder] Paketo BellSoft Liberica Buildpack 2.3.1
[builder]     Set $BP_JAVA_VERSION to configure the Java version. Default 11.*.
[builder]     Set $BPL_HEAD_ROOM to configure the headroom in memory calculation. Default 0.
[builder]     Set $BPL_LOADED_CLASS_COUNT to configure the number of loaded classes in memory calculation. Default 35% of classes.
[builder]     Set $BPL_THREAD_COUNT to configure the number of threads in memory calculation. Default 250.
[builder]   BellSoft Liberica JRE 11.0.7: Contributing to layer
[builder]     Downloading from https://github.com/bell-sw/Liberica/releases/download/11.0.7+10/bellsoft-jre11.0.7+10-linux-amd64.tar.gz
[builder]     Verifying checksum
[builder]     Expanding to /layers/paketo-buildpacks_bellsoft-liberica/jre
[builder]     Writing env/JAVA_HOME.override
[builder]     Writing env/MALLOC_ARENA_MAX.override
[builder]     Writing profile.d/active-processor-count.sh
[builder]   JVMKill Agent 1.16.0: Contributing to layer
[builder]     Downloading from https://github.com/cloudfoundry/jvmkill/releases/download/v1.16.0.RELEASE/jvmkill-1.16.0-RELEASE.so
[builder]     Verifying checksum
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/jvmkill
[builder]     Writing env/JAVA_OPTS.append
[builder]   Link-Local DNS: Contributing to layer
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/link-local-dns
[builder]     Writing profile.d/link-local-dns.sh
[builder]   Memory Calculator 4.0.0: Contributing to layer
[builder]     Downloading from https://github.com/cloudfoundry/java-buildpack-memory-calculator/releases/download/v4.0.0/memory-calculator-4.0.0.tgz
[builder]     Verifying checksum
[builder]     Expanding to /layers/paketo-buildpacks_bellsoft-liberica/memory-calculator
[builder]     Writing profile.d/memory-calculator.sh
[builder]   Class Counter: Contributing to layer
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/class-counter
[builder]   Java Security Properties: Contributing to layer
[builder]     Writing env.launch/JAVA_OPTS.append
[builder]     Writing env.launch/JAVA_SECURITY_PROPERTIES.override
[builder]   Security Providers Configurer: Contributing to layer
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/security-providers-configurer
[builder]     Writing profile.d/security-providers-classpath.sh
[builder]     Writing profile.d/security-providers-configurer.sh
[builder] 
[builder] Paketo Apache Tomcat Buildpack 1.1.1
[builder]     Set $BP_TOMCAT_CONTEXT_PATH to configure the application context path. Default ROOT.
[builder]     Set $BP_TOMCAT_EXT_CONF_SHA256 to configure the SHA256 hash of the external Tomcat configuration archive. Default <none>.
[builder]     Set $BP_TOMCAT_EXT_CONF_STRIP to configure the number of directory components to strip from the external Tomcat configuration archive. Default 0.
[builder]     Set $BP_TOMCAT_EXT_CONF_URI to configure the download location of the external Tomcat configuration. Default <none>.
[builder]     Set $BP_TOMCAT_EXT_CONF_VERSION to configure the version of the external Tomcat configuration. Default <none>.
[builder]     Set $BP_TOMCAT_VERSION to configure the Tomcat version. Default 9.*.
[builder]     Set $BPL_TOMCAT_ACCESS_LOGGING to configure the Tomcat access logging state. Default disabled.
[builder]   Apache Tomcat 9.0.34: Contributing to layer
[builder]     Downloading from https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.34/bin/apache-tomcat-9.0.34.tar.gz
[builder]     Verifying checksum
[builder]     Expanding to /layers/paketo-buildpacks_apache-tomcat/catalina-home
[builder]     Writing env.launch/CATALINA_HOME.override
[builder]   Apache Tomcat Support: Contributing to layer
[builder]     Copying context.xml to /layers/paketo-buildpacks_apache-tomcat/catalina-base/conf
[builder]     Copying logging.properties to /layers/paketo-buildpacks_apache-tomcat/catalina-base/conf
[builder]     Copying server.xml to /layers/paketo-buildpacks_apache-tomcat/catalina-base/conf
[builder]     Copying web.xml to /layers/paketo-buildpacks_apache-tomcat/catalina-base/conf
[builder]   Apache Tomcat Access Logging Support 3.3.0
[builder]     Downloading from https://repo.spring.io/release/org/cloudfoundry/tomcat-access-logging-support/3.3.0.RELEASE/tomcat-access-logging-support-3.3.0.RELEASE.jar
[builder]     Verifying checksum
[builder]     Copying to /layers/paketo-buildpacks_apache-tomcat/catalina-base/lib
[builder]   Apache Tomcat Lifecycle Support 3.3.0
[builder]     Downloading from https://repo.spring.io/release/org/cloudfoundry/tomcat-lifecycle-support/3.3.0.RELEASE/tomcat-lifecycle-support-3.3.0.RELEASE.jar
[builder]     Verifying checksum
[builder]     Copying to /layers/paketo-buildpacks_apache-tomcat/catalina-base/lib
[builder]   Apache Tomcat Logging Support 3.3.0
[builder]     Downloading from https://repo.spring.io/release/org/cloudfoundry/tomcat-logging-support/3.3.0.RELEASE/tomcat-logging-support-3.3.0.RELEASE.jar
[builder]     Verifying checksum
[builder]     Copying to /layers/paketo-buildpacks_apache-tomcat/catalina-base/bin
[builder]     Writing /layers/paketo-buildpacks_apache-tomcat/catalina-base/bin/setenv.sh
[builder]   Mounting application at ROOT
[builder]     Writing env.launch/CATALINA_BASE.override
[builder]     Writing profile.d/access-logging-support.sh
[builder]   Process types:
[builder]     task:   catalina.sh run
[builder]     tomcat: catalina.sh run
[builder]     web:    catalina.sh run
===> EXPORTING
[exporter] Adding layer 'launcher'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:class-counter'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:java-security-properties'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:jre'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:jvmkill'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:link-local-dns'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:memory-calculator'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:security-providers-configurer'
[exporter] Adding layer 'paketo-buildpacks/apache-tomcat:catalina-base'
[exporter] Adding layer 'paketo-buildpacks/apache-tomcat:catalina-home'
[exporter] Adding 1/1 app layer(s)
[exporter] Adding layer 'config'
[exporter] *** Images (562795acce7b):
[exporter]       index.docker.io/making/pack-servlet:latest
Successfully built image making/pack-servlet
```

今回はイメージビルド時にMavenによるビルドは実行されません。

> * JDKのバージョンはビルド時に[環境変数`BP_JAVA_VERSION`を設定](https://github.com/paketo-buildpacks/bellsoft-liberica#configuration)することで指定できます。デフォルトは`11.*`です。(例: `-e BP_JAVA_VERSION=8.*`)

`pack inspect-image`でイメージを解析します。

```
$ pack inspect-image making/pack-servlet
Inspecting image: making/pack-servlet

REMOTE:
(not present)

LOCAL:

Stack: io.buildpacks.stacks.bionic

Base Image:
  Reference: 40845d52d6fb6d285a320aeac821b61cff0e2863e0ff12e12138c4775aae1828
  Top Layer: sha256:f0d87426c0a82340475d73a9108b063d3d3cfbd92ef3b4af74dcd8f904475a36

Run Images:
  gcr.io/paketo-buildpacks/run:base-cnb

Buildpacks:
  ID                                         VERSION
  paketo-buildpacks/bellsoft-liberica        2.3.1
  paketo-buildpacks/apache-tomcat            1.1.1
  paketo-buildpacks/spring-boot              1.5.1
  paketo-buildpacks/dist-zip                 1.2.1

Processes:
  TYPE                 SHELL        COMMAND                ARGS
  web (default)        bash         catalina.sh run        
  task                 bash         catalina.sh run        
  tomcat               bash         catalina.sh run        
```

### イメージの実行

作成したイメージを`docker run`で起動します。

```
docker run --rm -p 8080:8080 making/pack-servlet
```

起動時に次のようなログが出力されます。

```
Container memory limit unset. Configuring JVM for 1G container.
Calculated JVM Memory Configuration: -XX:MaxDirectMemorySize=10M -XX:MaxMetaspaceSize=61686K -XX:ReservedCodeCacheSize=240M -Xss1M -Xmx474889K (Head Room: 0%, Loaded Class Count: 8477, Thread Count: 250, Total Memory: 1073741824)
NOTE: Picked up JDK_JAVA_OPTIONS:  --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.io=ALL-UNNAMED --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMED
[CONTAINER] org.apache.coyote.http11.Http11NioProtocol         INFO    Initializing ProtocolHandler ["http-nio-8080"]
[CONTAINER] org.apache.catalina.startup.Catalina               INFO    Server initialization in [568] milliseconds
[CONTAINER] org.apache.catalina.core.StandardService           INFO    Starting service [Catalina]
[CONTAINER] org.apache.catalina.core.StandardEngine            INFO    Starting Servlet engine: [Apache Tomcat/9.0.34]
[CONTAINER] org.apache.catalina.startup.HostConfig             INFO    Deploying web application directory [/layers/paketo-buildpacks_apache-tomcat/catalina-base/webapps/ROOT]
[CONTAINER] org.apache.jasper.servlet.TldScanner               INFO    At least one JAR was scanned for TLDs yet contained no TLDs. Enable debug logging for this logger for a complete list of JARs that were scanned but no TLDs were found in them. Skipping unneeded JARs during scanning can improve startup time and JSP compilation time.
[CONTAINER] org.apache.catalina.startup.HostConfig             INFO    Deployment of web application directory [/layers/paketo-buildpacks_apache-tomcat/catalina-base/webapps/ROOT] has finished in [290] ms
[CONTAINER] org.apache.coyote.http11.Http11NioProtocol         INFO    Starting ProtocolHandler ["http-nio-8080"]
[CONTAINER] org.apache.catalina.startup.Catalina               INFO    Server startup in [355] milliseconds
```

JVMのメモリが自動で設定されていることに注目してください。

アプリケーションにアクセスします。

```
$ curl localhost:8080 -w '\n'
Hello World!
```

Docker Imageのサイズを確認します。

```
$ docker images | grep making/pack-servlet
making/pack-servlet                  latest              562795acce7b        40 years ago        256MB
```

Java Buildpackの細かい設定は
https://github.com/paketo-buildpacks/java
を確認してください。

おわったらDocker Imageを削除します。

```
docker rmi making/pack-servlet
```