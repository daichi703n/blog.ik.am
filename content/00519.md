---
title: cf-for-k8s (CF4K8s)をKind上にインストールする
tags: ["Cloud Foundry", "Kubernetes", "CF4K8s"]
categories: ["Dev", "PaaS", "CloudFoundry", "CF4K8s"]
---


Cloud FoundryをKubernetes上にインストールする[cf-for-k8s (CF4K8s)](https://github.com/cloudfoundry/cf-for-k8s)の0.1.0がリリースされたので試してみます。
今回は[Kind](https://github.com/kubernetes-sigs/kind)をLaptopにインストールし、その上にCloud Foundryをインストールします。

> CFをk8s上にデプロイするプロジェクトとしては[KubeCF](https://github.com/cloudfoundry-incubator/kubecf)もありますが、
> KubeCFは既存のCFのコンポーネントをBOSHの概念と共にKubenetesに移植したプロジェクトです。既存のCF利用者からすると短期的にはKubeCFの方が移行しやすいかもしれません。
> 一方、cf-for-k8sは、CFのコンポーネントをKubernetesの世界に合わせて置き換えたり(Envoy, Istio, Fluentd, Kpackなど)、書き換えたりしています。
> 既存CF利用者視点での互換性はKubeCFに比べて低いですが、将来的に見るとcf-for-k8sのアプローチの方が正しいように思えます。ちなみにKubeCFはHelmでインストールし、cf-for-k8sは[kapp](https://get-kapp.io/)でインストールします。
> cf-for-k8sは[VMware Tanzu Application Service for Kubernetes (TAS for k8s)](https://network.pivotal.io/products/tas-for-kubernetes)のベースとなっています。

本記事の内容は基本的に次のドキュメントの通りです。

https://github.com/cloudfoundry/cf-for-k8s/blob/master/docs/deploy-local.md

### CLIのインストール

* [`kubectl`](https://github.com/kubernetes/kubectl)
* [`kind`](https://github.com/kubernetes-sigs/kind)
* [`kapp`](https://get-kapp.io/) (cf-for-k8sのデプロイに使用します)
* [`ytt`](https://get-ytt.io/) (yamlのpatchを適用するために使用します)
* [`bosh`](https://github.com/cloudfoundry/bosh-cli) (yaml内のパスワードとTLS証明書を自動生成するために使用します)
* [`cf`](https://github.com/cloudfoundry/cli)

をインストールします。

```
brew install kubectl
brew install kind
brew install k14s/tap/kapp
brew install k14s/tap/ytt
brew install cloudfoundry/tap/bosh-cli
brew install cloudfoundry/tap/cf-cli
```

動作確認したバージョンは

```
$ kind --version
kind version 0.7.0

$ kubectl version --client=true 
Client Version: version.Info{Major:"1", Minor:"17", GitVersion:"v1.17.3", GitCommit:"06ad960bfd03b39c8310aaf92d1e7c12ce618213", GitTreeState:"clean", BuildDate:"2020-02-13T18:08:14Z", GoVersion:"go1.13.8", Compiler:"gc", Platform:"darwin/amd64"}

$ kapp version
kapp version 0.24.

$ ytt version
ytt version 0.27.1

$ bosh -v      
version 6.2.1-a28042ac-2020-02-10T18:41:00Z

$ cf -v
cf version 6.51.0+2acd15650.2020-04-07
```

です。

### cf-for-k8sマニフェストの取得

[`0.1.0`](https://github.com/cloudfoundry/cf-for-k8s/releases/tag/v0.1.0)を使用します。

```
git clone https://github.com/cloudfoundry/cf-for-k8s.git -b v0.1.0
```

### Kubernetesクラスターの作成

cf-for-k8sで使用するKubernetesをKindで作成します。Kind用のconfigは[`cf-for-k8s/deploy/kind/cluster.yml`](https://github.com/cloudfoundry/cf-for-k8s/blob/v0.1.0/deploy/kind/cluster.yml)に用意されています。

```
kind create cluster --config=./cf-for-k8s/deploy/kind/cluster.yml
```

Kindでは`LoadBalancer` typeの`Service`を作成できないため、hostの`443`ポートをKind内の`31443`ポートに、hostの`80`ポートを`31080`ポートにマッピングするように設定し、
cf-for-k8sが`LoadBalancer`の代わりに`NodePort`を使用しても、ホストから`443` or `80`ポートでアクセスできるようにしています。

クラスタが作成されたら`kubectl`で動作確認します。

```
$ kubectl cluster-info
Kubernetes master is running at https://127.0.0.1:32769
KubeDNS is running at https://127.0.0.1:32769/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

$ kubectl get node
NAME                 STATUS   ROLES    AGE   VERSION
kind-control-plane   Ready    master   10m   v1.17.0

$ kubectl get pod -A
NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE
kube-system          coredns-6955765f44-n4qzd                     1/1     Running   0          3m42s
kube-system          coredns-6955765f44-thqj8                     1/1     Running   0          3m42s
kube-system          etcd-kind-control-plane                      1/1     Running   0          3m57s
kube-system          kindnet-s9l7m                                1/1     Running   0          3m42s
kube-system          kube-apiserver-kind-control-plane            1/1     Running   0          3m57s
kube-system          kube-controller-manager-kind-control-plane   1/1     Running   0          3m57s
kube-system          kube-proxy-jfbm8                             1/1     Running   0          3m42s
kube-system          kube-scheduler-kind-control-plane            1/1     Running   0          3m57s
local-path-storage   local-path-provisioner-7745554f7f-vnwh9      1/1     Running   0          3m42s
```

KindにはMetrics Serverが含まれておらず、これがないと[`cf push`でエラーが発生する](https://github.com/cloudfoundry/cf-for-k8s/issues/123)ので、Metrics Serverを別途インストールしておきます。

```
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.6/components.yaml
```


### Cloud Foundryのインストール

いよいよk8s上にCloud Foundryをインストールを行います。

まずは、ソースコードを`cf push`した際にCloud Native Buildpackで作成されるDockerイメージをデプロイするDockerレジストリのアカウント情報を設定します。
ここではDockerHubを使用します。
また、パスワードや証明書を自動生成して`./cf-for-k8s/hack/generate-values.sh`を実行して設定値を作成します。
CFのドメインには`local.maki.lol`を使用します。

> `*.locall.maki.lol`及び`*.apps.local.maki.lol`、`*.sys.local.maki.lol`はAレコードで`127.0.0.1`を返すように登録s亭あります。誰でも利用可能です。


```
export DOCKERHUB_USERNAME=.......
export DOCKERHUB_PASSWORD=....

./cf-for-k8s/hack/generate-values.sh -d local.maki.lol > /tmp/cf-values.yml

cat <<EOF >> /tmp/cf-values.yml
app_registry:
   hostname: https://index.docker.io/v1/
   repository: ${DOCKERHUB_USERNAME}
   username: ${DOCKERHUB_USERNAME}
   password: ${DOCKERHUB_PASSWORD}
EOF
```

設定ファイルは`/tmp/cf-value.yml`に出力されます。`kapp`及び`ytt`を使用して次のコマンドでデプロイします。

```
kapp deploy -a cf \
  -f <(ytt -f ./cf-for-k8s/config \
           -f /tmp/cf-values.yml \
           -f ./cf-for-k8s/config-optional/remove-resource-requirements.yml \
           -f ./cf-for-k8s/config-optional/use-nodeport-for-ingress.yml)
```


ベースのマニフェストファイルは`cf-for-k8s/config`に含まれます。これに対して、次の差分ファイルを`ytt`で適用しています。

* `cf-for-k8s/config-optional/remove-resource-requirements.yml` ... Kindでもデプロイできるようにリソース(CPU、メモリ)の下限の制約を除外する
* `cf-for-k8s/config-optional/use-nodeport-for-ingress.yml` ... IstionのIngress Gatewayに`NodePort`を使用する

`kapp`でデプロイすると、変更のあるリソース一覧が出力され、これを確認してからデプロイできます。

<details>
  <summary>実行例(クリックして確認)</summary>

```
$ kapp deploy -a cf \
  -f <(ytt -f ./cf-for-k8s/config \
           -f /tmp/cf-values.yml \
           -f ./cf-for-k8s/config-optional/remove-resource-requirements.yml \
           -f ./cf-for-k8s/config-optional/use-nodeport-for-ingress.yml)
Target cluster 'https://127.0.0.1:32768' (nodes: kind-control-plane)

Changes

Namespace             Name                                                            Kind                          Conds.  Age  Op      Wait to    Rs  Ri  
(cluster)             adapters.config.istio.io                                        CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     aggregate-metacontroller-edit                                   ClusterRole                   -       -    create  reconcile  -   -  
^                     aggregate-metacontroller-view                                   ClusterRole                   -       -    create  reconcile  -   -  
^                     attributemanifests.config.istio.io                              CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     authorizationpolicies.security.istio.io                         CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     builders.build.pivotal.io                                       CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     builds.build.pivotal.io                                         CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     cc-api-service-account-superuser                                ClusterRoleBinding            -       -    create  reconcile  -   -  
^                     cf-blobstore                                                    Namespace                     -       -    create  reconcile  -   -  
^                     cf-db                                                           Namespace                     -       -    create  reconcile  -   -  
^                     cf-system                                                       Namespace                     -       -    create  reconcile  -   -  
^                     cf-workloads                                                    Namespace                     -       -    create  reconcile  -   -  
^                     cf-workloads-app-psp                                            PodSecurityPolicy             -       -    create  reconcile  -   -  
^                     cf-workloads-privileged-app-psp                                 PodSecurityPolicy             -       -    create  reconcile  -   -  
^                     cf-workloads-staging                                            Namespace                     -       -    create  reconcile  -   -  
^                     cfroutesync                                                     CompositeController           -       -    create  reconcile  -   -  
^                     clusterbuilders.build.pivotal.io                                CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     clusterrbacconfigs.rbac.istio.io                                CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     compositecontrollers.metacontroller.k8s.io                      CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     controllerrevisions.metacontroller.k8s.io                       CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     custombuilders.experimental.kpack.pivotal.io                    CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     customclusterbuilders.experimental.kpack.pivotal.io             CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     decoratorcontrollers.metacontroller.k8s.io                      CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     default                                                         MeshPolicy                    -       -    create  reconcile  -   -  
^                     destinationrules.networking.istio.io                            CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     eirini                                                          PodSecurityPolicy             -       -    create  reconcile  -   -  
^                     envoyfilters.networking.istio.io                                CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     fluentd-service-account-pod-namespace-read                      ClusterRoleBinding            -       -    create  reconcile  -   -  
^                     gateways.networking.istio.io                                    CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     handlers.config.istio.io                                        CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     httpapispecbindings.config.istio.io                             CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     httpapispecs.config.istio.io                                    CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     images.build.pivotal.io                                         CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     instances.config.istio.io                                       CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     istio-citadel-istio-system                                      ClusterRole                   -       -    create  reconcile  -   -  
^                     istio-citadel-istio-system                                      ClusterRoleBinding            -       -    create  reconcile  -   -  
^                     istio-galley-admin-role-binding-istio-system                    ClusterRoleBinding            -       -    create  reconcile  -   -  
^                     istio-galley-istio-system                                       ClusterRole                   -       -    create  reconcile  -   -  
^                     istio-mixer-admin-role-binding-istio-system                     ClusterRoleBinding            -       -    create  reconcile  -   -  
^                     istio-mixer-istio-system                                        ClusterRole                   -       -    create  reconcile  -   -  
^                     istio-pilot-istio-system                                        ClusterRole                   -       -    create  reconcile  -   -  
^                     istio-pilot-istio-system                                        ClusterRoleBinding            -       -    create  reconcile  -   -  
^                     istio-policy                                                    ClusterRole                   -       -    create  reconcile  -   -  
^                     istio-policy-admin-role-binding-istio-system                    ClusterRoleBinding            -       -    create  reconcile  -   -  
^                     istio-reader-istio-system                                       ClusterRole                   -       -    create  reconcile  -   -  
^                     istio-reader-istio-system                                       ClusterRoleBinding            -       -    create  reconcile  -   -  
^                     istio-sidecar-injector                                          MutatingWebhookConfiguration  -       -    create  reconcile  -   -  
^                     istio-sidecar-injector-admin-role-binding-istio-system          ClusterRoleBinding            -       -    create  reconcile  -   -  
^                     istio-sidecar-injector-istio-system                             ClusterRole                   -       -    create  reconcile  -   -  
^                     istio-system                                                    Namespace                     -       -    create  reconcile  -   -  
^                     kpack                                                           Namespace                     -       -    create  reconcile  -   -  
^                     kpack-controller-admin                                          ClusterRole                   -       -    create  reconcile  -   -  
^                     kpack-controller-admin-binding                                  ClusterRoleBinding            -       -    create  reconcile  -   -  
^                     kpack-watcher                                                   ClusterRole                   -       -    create  reconcile  -   -  
^                     kpack-watcher-binding                                           ClusterRoleBinding            -       -    create  reconcile  -   -  
^                     kpack-webhook-certs-mutatingwebhookconfiguration-admin-binding  ClusterRoleBinding            -       -    create  reconcile  -   -  
^                     kpack-webhook-mutatingwebhookconfiguration-admin                ClusterRole                   -       -    create  reconcile  -   -  
^                     meshpolicies.authentication.istio.io                            CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     metacontroller                                                  ClusterRole                   -       -    create  reconcile  -   -  
^                     metacontroller                                                  ClusterRoleBinding            -       -    create  reconcile  -   -  
^                     metacontroller                                                  Namespace                     -       -    create  reconcile  -   -  
^                     metric-proxy                                                    ClusterRole                   -       -    create  reconcile  -   -  
^                     metric-proxy                                                    ClusterRoleBinding            -       -    create  reconcile  -   -  
^                     pod-namespace-read                                              ClusterRole                   -       -    create  reconcile  -   -  
^                     policies.authentication.istio.io                                CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     quotaspecbindings.config.istio.io                               CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     quotaspecs.config.istio.io                                      CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     rbacconfigs.rbac.istio.io                                       CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     resource.webhook.kpack.pivotal.io                               MutatingWebhookConfiguration  -       -    create  reconcile  -   -  
^                     routebulksyncs.apps.cloudfoundry.org                            CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     rules.config.istio.io                                           CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     serviceentries.networking.istio.io                              CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     servicerolebindings.rbac.istio.io                               CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     serviceroles.rbac.istio.io                                      CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     sidecars.networking.istio.io                                    CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     sourceresolvers.build.pivotal.io                                CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     stacks.experimental.kpack.pivotal.io                            CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     stores.experimental.kpack.pivotal.io                            CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     templates.config.istio.io                                       CustomResourceDefinition      -       -    create  reconcile  -   -  
^                     virtualservices.networking.istio.io                             CustomResourceDefinition      -       -    create  reconcile  -   -  
cf-blobstore          cf-blobstore-allow-plaintext                                    Policy                        -       -    create  reconcile  -   -  
^                     cf-blobstore-minio                                              ConfigMap                     -       -    create  reconcile  -   -  
^                     cf-blobstore-minio                                              Deployment                    -       -    create  reconcile  -   -  
^                     cf-blobstore-minio                                              PersistentVolumeClaim         -       -    create  reconcile  -   -  
^                     cf-blobstore-minio                                              Secret                        -       -    create  reconcile  -   -  
^                     cf-blobstore-minio                                              Service                       -       -    create  reconcile  -   -  
^                     cf-blobstore-minio                                              ServiceAccount                -       -    create  reconcile  -   -  
cf-db                 cf-db-admin-secret                                              Secret                        -       -    create  reconcile  -   -  
^                     cf-db-allow-plaintext                                           Policy                        -       -    create  reconcile  -   -  
^                     cf-db-credentials                                               Secret                        -       -    create  reconcile  -   -  
^                     cf-db-postgresql                                                Service                       -       -    create  reconcile  -   -  
^                     cf-db-postgresql                                                StatefulSet                   -       -    create  reconcile  -   -  
^                     cf-db-postgresql-headless                                       Service                       -       -    create  reconcile  -   -  
^                     cf-db-postgresql-init-scripts                                   ConfigMap                     -       -    create  reconcile  -   -  
cf-system             capi                                                            Service                       -       -    create  reconcile  -   -  
^                     capi-api-server                                                 Deployment                    -       -    create  reconcile  -   -  
^                     capi-clock                                                      Deployment                    -       -    create  reconcile  -   -  
^                     capi-deployment-updater                                         Deployment                    -       -    create  reconcile  -   -  
^                     capi-external-virtual-service                                   VirtualService                -       -    create  reconcile  -   -  
^                     capi-kpack-watcher                                              Deployment                    -       -    create  reconcile  -   -  
^                     capi-worker                                                     Deployment                    -       -    create  reconcile  -   -  
^                     cc-api-service-account                                          ServiceAccount                -       -    create  reconcile  -   -  
^                     cfroutesync                                                     Deployment                    -       -    create  reconcile  -   -  
^                     cfroutesync                                                     Secret                        -       -    create  reconcile  -   -  
^                     cfroutesync                                                     Service                       -       -    create  reconcile  -   -  
^                     cfroutesync-auth-metacontroller                                 AuthorizationPolicy           -       -    create  reconcile  -   -  
^                     cfroutesync-auth-prometheus                                     AuthorizationPolicy           -       -    create  reconcile  -   -  
^                     cfroutesync-config-ver-1                                        ConfigMap                     -       -    create  reconcile  -   -  
^                     cloud-controller-ng-yaml-ver-1                                  ConfigMap                     -       -    create  reconcile  -   -  
^                     eirini                                                          ConfigMap                     -       -    create  reconcile  -   -  
^                     eirini                                                          Deployment                    -       -    create  reconcile  -   -  
^                     eirini                                                          Service                       -       -    create  reconcile  -   -  
^                     eirini-internal-tls-certs                                       Secret                        -       -    create  reconcile  -   -  
^                     eirini-role                                                     Role                          -       -    create  reconcile  -   -  
^                     eirini-rolebinding                                              RoleBinding                   -       -    create  reconcile  -   -  
^                     fluentd                                                         DaemonSet                     -       -    create  reconcile  -   -  
^                     fluentd-config                                                  ConfigMap                     -       -    create  reconcile  -   -  
^                     fluentd-service-account                                         ServiceAccount                -       -    create  reconcile  -   -  
^                     istio-ingressgateway                                            Gateway                       -       -    create  reconcile  -   -  
^                     log-cache                                                       Deployment                    -       -    create  reconcile  -   -  
^                     log-cache                                                       Secret                        -       -    create  reconcile  -   -  
^                     log-cache                                                       Service                       -       -    create  reconcile  -   -  
^                     log-cache-ca                                                    Secret                        -       -    create  reconcile  -   -  
^                     log-cache-external-virtual-service                              VirtualService                -       -    create  reconcile  -   -  
^                     log-cache-gateway                                               Secret                        -       -    create  reconcile  -   -  
^                     log-cache-metrics                                               Secret                        -       -    create  reconcile  -   -  
^                     log-cache-syslog                                                Secret                        -       -    create  reconcile  -   -  
^                     log-cache-syslog                                                Service                       -       -    create  reconcile  -   -  
^                     metric-proxy                                                    Deployment                    -       -    create  reconcile  -   -  
^                     metric-proxy                                                    Service                       -       -    create  reconcile  -   -  
^                     metric-proxy                                                    ServiceAccount                -       -    create  reconcile  -   -  
^                     metric-proxy-ca                                                 Secret                        -       -    create  reconcile  -   -  
^                     metric-proxy-cert                                               Secret                        -       -    create  reconcile  -   -  
^                     nginx-ver-1                                                     ConfigMap                     -       -    create  reconcile  -   -  
^                     opi                                                             ServiceAccount                -       -    create  reconcile  -   -  
^                     opi-secrets                                                     Secret                        -       -    create  reconcile  -   -  
^                     uaa                                                             Deployment                    -       -    create  reconcile  -   -  
^                     uaa                                                             Service                       -       -    create  reconcile  -   -  
^                     uaa                                                             ServiceAccount                -       -    create  reconcile  -   -  
^                     uaa-certs                                                       Secret                        -       -    create  reconcile  -   -  
^                     uaa-config                                                      ConfigMap                     -       -    create  reconcile  -   -  
^                     uaa-external-virtual-service                                    VirtualService                -       -    create  reconcile  -   -  
cf-workloads          allow-app-ingress-from-ingressgateway                           NetworkPolicy                 -       -    create  reconcile  -   -  
^                     app-registry-credentials                                        Secret                        -       -    create  reconcile  -   -  
^                     cf-workloads-app-role                                           Role                          -       -    create  reconcile  -   -  
^                     cf-workloads-app-rolebinding                                    RoleBinding                   -       -    create  reconcile  -   -  
^                     cf-workloads-privileged-app-role                                Role                          -       -    create  reconcile  -   -  
^                     cf-workloads-privileged-app-rolebinding                         RoleBinding                   -       -    create  reconcile  -   -  
^                     default                                                         Sidecar                       -       -    create  reconcile  -   -  
^                     deny-app-ingress                                                NetworkPolicy                 -       -    create  reconcile  -   -  
^                     eirini                                                          ServiceAccount                -       -    create  reconcile  -   -  
^                     eirini-privileged                                               ServiceAccount                -       -    create  reconcile  -   -  
^                     eirini-role                                                     Role                          -       -    create  reconcile  -   -  
^                     eirini-rolebinding                                              RoleBinding                   -       -    create  reconcile  -   -  
^                     istio-ingress                                                   Gateway                       -       -    create  reconcile  -   -  
^                     kpack-watcher-pod-logs-binding                                  RoleBinding                   -       -    create  reconcile  -   -  
^                     kpack-watcher-pod-logs-reader                                   Role                          -       -    create  reconcile  -   -  
^                     route-bulk-sync                                                 RouteBulkSync                 -       -    create  reconcile  -   -  
cf-workloads-staging  cc-kpack-registry-auth-secret                                   Secret                        -       -    create  reconcile  -   -  
^                     cc-kpack-registry-service-account                               ServiceAccount                -       -    create  reconcile  -   -  
^                     cf-autodetect-builder                                           Builder                       -       -    create  reconcile  -   -  
istio-system          attributes                                                      instance                      -       -    create  reconcile  -   -  
^                     cf-prometheus                                                   handler                       -       -    create  reconcile  -   -  
^                     cf-promhttp                                                     rule                          -       -    create  reconcile  -   -  
^                     cfrequestcount                                                  instance                      -       -    create  reconcile  -   -  
^                     citadel-network-policy                                          NetworkPolicy                 -       -    create  reconcile  -   -  
^                     default                                                         Sidecar                       -       -    create  reconcile  -   -  
^                     galley-envoy-config                                             ConfigMap                     -       -    create  reconcile  -   -  
^                     ingressgateway                                                  Gateway                       -       -    create  reconcile  -   -  
^                     ingressgateway                                                  PodDisruptionBudget           -       -    create  reconcile  -   -  
^                     ingressgateway-network-policy-pilot                             NetworkPolicy                 -       -    create  reconcile  -   -  
^                     injector-mesh                                                   ConfigMap                     -       -    create  reconcile  -   -  
^                     istio                                                           ConfigMap                     -       -    create  reconcile  -   -  
^                     istio-citadel                                                   Deployment                    -       -    create  reconcile  -   -  
^                     istio-citadel                                                   PodDisruptionBudget           -       -    create  reconcile  -   -  
^                     istio-citadel                                                   Service                       -       -    create  reconcile  -   -  
^                     istio-citadel-service-account                                   ServiceAccount                -       -    create  reconcile  -   -  
^                     istio-galley                                                    Deployment                    -       -    create  reconcile  -   -  
^                     istio-galley                                                    PodDisruptionBudget           -       -    create  reconcile  -   -  
^                     istio-galley                                                    Service                       -       -    create  reconcile  -   -  
^                     istio-galley-configuration                                      ConfigMap                     -       -    create  reconcile  -   -  
^                     istio-galley-service-account                                    ServiceAccount                -       -    create  reconcile  -   -  
^                     istio-ingressgateway                                            DaemonSet                     -       -    create  reconcile  -   -  
^                     istio-ingressgateway                                            Service                       -       -    create  reconcile  -   -  
^                     istio-ingressgateway-certs                                      Secret                        -       -    create  reconcile  -   -  
^                     istio-ingressgateway-sds                                        Role                          -       -    create  reconcile  -   -  
^                     istio-ingressgateway-sds                                        RoleBinding                   -       -    create  reconcile  -   -  
^                     istio-ingressgateway-service-account                            ServiceAccount                -       -    create  reconcile  -   -  
^                     istio-mesh-galley                                               ConfigMap                     -       -    create  reconcile  -   -  
^                     istio-mixer-service-account                                     ServiceAccount                -       -    create  reconcile  -   -  
^                     istio-pilot                                                     Deployment                    -       -    create  reconcile  -   -  
^                     istio-pilot                                                     HorizontalPodAutoscaler       -       -    create  reconcile  -   -  
^                     istio-pilot                                                     PodDisruptionBudget           -       -    create  reconcile  -   -  
^                     istio-pilot                                                     Service                       -       -    create  reconcile  -   -  
^                     istio-pilot-service-account                                     ServiceAccount                -       -    create  reconcile  -   -  
^                     istio-policy                                                    Deployment                    -       -    create  reconcile  -   -  
^                     istio-policy                                                    DestinationRule               -       -    create  reconcile  -   -  
^                     istio-policy                                                    HorizontalPodAutoscaler       -       -    create  reconcile  -   -  
^                     istio-policy                                                    PodDisruptionBudget           -       -    create  reconcile  -   -  
^                     istio-policy                                                    Service                       -       -    create  reconcile  -   -  
^                     istio-policy-service-account                                    ServiceAccount                -       -    create  reconcile  -   -  
^                     istio-reader-service-account                                    ServiceAccount                -       -    create  reconcile  -   -  
^                     istio-sidecar-injector                                          ConfigMap                     -       -    create  reconcile  -   -  
^                     istio-sidecar-injector                                          Deployment                    -       -    create  reconcile  -   -  
^                     istio-sidecar-injector                                          PodDisruptionBudget           -       -    create  reconcile  -   -  
^                     istio-sidecar-injector                                          Service                       -       -    create  reconcile  -   -  
^                     istio-sidecar-injector-service-account                          ServiceAccount                -       -    create  reconcile  -   -  
^                     istio-telemetry                                                 Deployment                    -       -    create  reconcile  -   -  
^                     istio-telemetry                                                 DestinationRule               -       -    create  reconcile  -   -  
^                     istio-telemetry                                                 HorizontalPodAutoscaler       -       -    create  reconcile  -   -  
^                     istio-telemetry                                                 PodDisruptionBudget           -       -    create  reconcile  -   -  
^                     istio-telemetry                                                 Service                       -       -    create  reconcile  -   -  
^                     istioproxy                                                      attributemanifest             -       -    create  reconcile  -   -  
^                     kubeattrgenrulerule                                             rule                          -       -    create  reconcile  -   -  
^                     kubernetes                                                      attributemanifest             -       -    create  reconcile  -   -  
^                     kubernetesenv                                                   handler                       -       -    create  reconcile  -   -  
^                     mixer-network-policy                                            NetworkPolicy                 -       -    create  reconcile  -   -  
^                     pilot-envoy-config                                              ConfigMap                     -       -    create  reconcile  -   -  
^                     pilot-network-policy                                            NetworkPolicy                 -       -    create  reconcile  -   -  
^                     policy-envoy-config                                             ConfigMap                     -       -    create  reconcile  -   -  
^                     prometheus                                                      handler                       -       -    create  reconcile  -   -  
^                     promhttp                                                        rule                          -       -    create  reconcile  -   -  
^                     promtcp                                                         rule                          -       -    create  reconcile  -   -  
^                     promtcpconnectionclosed                                         rule                          -       -    create  reconcile  -   -  
^                     promtcpconnectionopen                                           rule                          -       -    create  reconcile  -   -  
^                     requestcount                                                    instance                      -       -    create  reconcile  -   -  
^                     requestduration                                                 instance                      -       -    create  reconcile  -   -  
^                     requestsize                                                     instance                      -       -    create  reconcile  -   -  
^                     responsesize                                                    instance                      -       -    create  reconcile  -   -  
^                     sidecar-injector-network-policy                                 NetworkPolicy                 -       -    create  reconcile  -   -  
^                     tcpbytereceived                                                 instance                      -       -    create  reconcile  -   -  
^                     tcpbytesent                                                     instance                      -       -    create  reconcile  -   -  
^                     tcpconnectionsclosed                                            instance                      -       -    create  reconcile  -   -  
^                     tcpconnectionsopened                                            instance                      -       -    create  reconcile  -   -  
^                     tcpkubeattrgenrulerule                                          rule                          -       -    create  reconcile  -   -  
^                     telemetry-envoy-config                                          ConfigMap                     -       -    create  reconcile  -   -  
kpack                 controller                                                      ServiceAccount                -       -    create  reconcile  -   -  
^                     kpack-controller                                                Deployment                    -       -    create  reconcile  -   -  
^                     kpack-webhook                                                   Deployment                    -       -    create  reconcile  -   -  
^                     kpack-webhook                                                   Service                       -       -    create  reconcile  -   -  
^                     kpack-webhook-certs-admin                                       Role                          -       -    create  reconcile  -   -  
^                     kpack-webhook-certs-admin-binding                               RoleBinding                   -       -    create  reconcile  -   -  
^                     webhook                                                         ServiceAccount                -       -    create  reconcile  -   -  
metacontroller        metacontroller                                                  ServiceAccount                -       -    create  reconcile  -   -  
^                     metacontroller                                                  StatefulSet                   -       -    create  reconcile  -   -  

Op:      245 create, 0 delete, 0 update, 0 noop
Wait to: 245 reconcile, 0 delete, 0 noop
```
</details>

`y`を入力してインストールを開始します。次のようなログが流れてインストールが成功します。

```
9:02:17PM: ---- applying 36 changes [0/245 done] ----
9:02:17PM: create customresourcedefinition/builds.build.pivotal.io (apiextensions.k8s.io/v1beta1) cluster
9:02:17PM: create customresourcedefinition/builders.build.pivotal.io (apiextensions.k8s.io/v1beta1) cluster
9:02:17PM: create customresourcedefinition/clusterbuilders.build.pivotal.io (apiextensions.k8s.io/v1beta1) cluster
9:02:17PM: create customresourcedefinition/custombuilders.experimental.kpack.pivotal.io (apiextensions.k8s.io/v1beta1) cluster
9:02:17PM: create customresourcedefinition/customclusterbuilders.experimental.kpack.pivotal.io (apiextensions.k8s.io/v1beta1) cluster
...(略)...
9:07:43PM:     ^ Condition Ready is not True (False)
9:07:44PM: ok: reconcile deployment/cf-blobstore-minio (apps/v1) namespace: cf-blobstore
9:07:44PM: ---- waiting on 1 changes [244/245 done] ----
9:07:47PM: ongoing: reconcile deployment/capi-api-server (apps/v1) namespace: cf-system
9:07:47PM:  ^ Waiting for 1 unavailable replicas
9:07:47PM:  L ok: waiting on replicaset/capi-api-server-bd668b897 (apps/v1) namespace: cf-system
9:07:47PM:  L ok: waiting on pod/capi-api-server-bd668b897-cprlv (v1) namespace: cf-system
9:07:47PM:  L ongoing: waiting on pod/capi-api-server-bd668b897-7drpp (v1) namespace: cf-system
9:07:47PM:     ^ Condition Ready is not True (False)
9:07:57PM: ok: reconcile deployment/capi-api-server (apps/v1) namespace: cf-system
9:07:57PM: ---- applying complete [245/245 done] ----
9:07:57PM: ---- waiting complete [245/245 done] ----

Succeeded
```

インストール後の`Pod`一覧は次の通りです。

```
$ kubectl get pod -A 
NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE
cf-blobstore         cf-blobstore-minio-6745578955-nz8bf          2/2     Running   0          4m43s
cf-db                cf-db-postgresql-0                           2/2     Running   0          4m53s
cf-system            capi-api-server-bd668b897-7drpp              5/5     Running   2          4m45s
cf-system            capi-api-server-bd668b897-cprlv              5/5     Running   3          4m45s
cf-system            capi-clock-76d55f5dc9-kqjnk                  2/2     Running   1          4m55s
cf-system            capi-deployment-updater-6b8bddb85b-m2fds     2/2     Running   1          4m53s
cf-system            capi-kpack-watcher-598bf58c77-gbjfb          2/2     Running   0          4m54s
cf-system            capi-worker-8bc56859d-jtdlw                  2/2     Running   1          4m53s
cf-system            cfroutesync-785c568d7b-krrvn                 2/2     Running   0          4m43s
cf-system            eirini-7d5b6f65cb-ndjwf                      2/2     Running   0          4m44s
cf-system            fluentd-d2zlm                                2/2     Running   0          4m54s
cf-system            log-cache-9cb8b6bd9-5fzb9                    5/5     Running   2          4m44s
cf-system            metric-proxy-6db4567cf9-jmcmh                2/2     Running   0          4m43s
cf-system            uaa-79bdb97476-xnwcz                         2/2     Running   0          4m42s
istio-system         istio-citadel-6c7788b-5cjm8                  1/1     Running   0          6m24s
istio-system         istio-galley-59647cbf86-jv7s7                2/2     Running   0          6m24s
istio-system         istio-ingressgateway-ldb72                   2/2     Running   0          6m
istio-system         istio-pilot-6cf5468446-wkrzg                 2/2     Running   0          6m23s
istio-system         istio-policy-6858f85497-kxw6n                2/2     Running   2          6m23s
istio-system         istio-sidecar-injector-6647645d86-xlbcw      1/1     Running   0          6m24s
istio-system         istio-telemetry-f84bd7d77-kjjrq              2/2     Running   1          6m23s
kpack                kpack-controller-559cd7f665-p6txb            1/1     Running   0          6m27s
kpack                kpack-webhook-5bdfdf487c-vv5vr               1/1     Running   0          6m26s
kube-system          coredns-6955765f44-n4qzd                     1/1     Running   0          29m
kube-system          coredns-6955765f44-thqj8                     1/1     Running   0          29m
kube-system          etcd-kind-control-plane                      1/1     Running   0          29m
kube-system          kindnet-s9l7m                                1/1     Running   0          29m
kube-system          kube-apiserver-kind-control-plane            1/1     Running   0          29m
kube-system          kube-controller-manager-kind-control-plane   1/1     Running   0          29m
kube-system          kube-proxy-jfbm8                             1/1     Running   0          29m
kube-system          kube-scheduler-kind-control-plane            1/1     Running   0          29m
local-path-storage   local-path-provisioner-7745554f7f-vnwh9      1/1     Running   0          29m
metacontroller       metacontroller-0                             2/2     Running   0          4m53s
```

インストール後の`Service`一覧は次の通りです。`istio-ingressgateway`が`NodePort`になっており、`31080`->`80`、`31443`->`443`になっていることに注目してください。
Kindの設定内容と一致します。

```
$ kubectl get svc -A
NAMESPACE      NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                                                                      AGE
cf-blobstore   cf-blobstore-minio          ClusterIP   10.96.78.163    <none>        9000/TCP                                                                                                                     6m34s
cf-db          cf-db-postgresql            ClusterIP   10.96.218.112   <none>        5432/TCP                                                                                                                     6m32s
cf-db          cf-db-postgresql-headless   ClusterIP   None            <none>        5432/TCP                                                                                                                     6m32s
cf-system      capi                        ClusterIP   10.96.131.69    <none>        80/TCP                                                                                                                       6m34s
cf-system      cfroutesync                 ClusterIP   10.96.8.232     <none>        80/TCP                                                                                                                       6m34s
cf-system      eirini                      ClusterIP   10.96.99.214    <none>        8085/TCP                                                                                                                     6m34s
cf-system      log-cache                   ClusterIP   10.96.95.99     <none>        8083/TCP                                                                                                                     6m34s
cf-system      log-cache-syslog            ClusterIP   10.96.207.232   <none>        8082/TCP                                                                                                                     6m34s
cf-system      metric-proxy                ClusterIP   10.96.76.205    <none>        8080/TCP                                                                                                                     6m34s
cf-system      uaa                         ClusterIP   10.96.43.61     <none>        8080/TCP                                                                                                                     6m32s
default        kubernetes                  ClusterIP   10.96.0.1       <none>        443/TCP                                                                                                                      29m
istio-system   istio-citadel               ClusterIP   10.96.221.120   <none>        8060/TCP,15014/TCP                                                                                                           6m34s
istio-system   istio-galley                ClusterIP   10.96.55.132    <none>        443/TCP,15014/TCP,9901/TCP,15019/TCP                                                                                         6m34s
istio-system   istio-ingressgateway        NodePort    10.96.33.9      <none>        15020:32508/TCP,80:31080/TCP,443:31443/TCP,15029:32477/TCP,15030:30356/TCP,15031:30882/TCP,15032:31281/TCP,15443:30490/TCP   6m33s
istio-system   istio-pilot                 ClusterIP   10.96.100.89    <none>        15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                       6m33s
istio-system   istio-policy                ClusterIP   10.96.107.158   <none>        9091/TCP,15004/TCP,15014/TCP                                                                                                 6m33s
istio-system   istio-sidecar-injector      ClusterIP   10.96.157.123   <none>        443/TCP                                                                                                                      6m33s
istio-system   istio-telemetry             ClusterIP   10.96.3.64      <none>        9091/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                       6m32s
kpack          kpack-webhook               ClusterIP   10.96.104.123   <none>        443/TCP                                                                                                                      6m34s
kube-system    kube-dns                    ClusterIP   10.96.0.10      <none>        53/UDP,53/TCP,9153/TCP   
kube-system    metrics-server              ClusterIP   10.96.161.224   <none>        443/TCP                                                                                                                      3m34s
```

インストール後の`PersistentVolume`一覧は次の通りです。データベースとしてPostgreSQL、BlobstoreとしてMinioが`PersistentVolume`を使用しています。


```
$ kubectl get pv    
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                             STORAGECLASS   REASON   AGE
pvc-dd2c1c7d-f741-4f9a-bd4a-b450baa24046   8Gi        RWO            Delete           Bound    cf-db/data-cf-db-postgresql-0     standard                5m33s
pvc-dea38d71-286c-415d-9754-a252deb94a59   10Gi       RWO            Delete           Bound    cf-blobstore/cf-blobstore-minio   standard                5m19s
```

`kapp`を使ってインストールした場合は`kapp inspect -a <アプリ名> --tree`コマンドで、作成されたリソース一覧を確認できます。


次のエンドポイントにアクセスして、Cloud Controllerのバージョンを確認できます。

```
$ curl -s -k https://api.local.maki.lol/v2/info | jq .
{
  "name": "",
  "build": "",
  "support": "",
  "version": 0,
  "description": "",
  "authorization_endpoint": "https://login.local.maki.lol",
  "token_endpoint": "https://uaa.local.maki.lol",
  "min_cli_version": "",
  "min_recommended_cli_version": "",
  "app_ssh_endpoint": "TODO.TODO",
  "app_ssh_host_key_fingerprint": "placeholder",
  "app_ssh_oauth_client": "placeholder",
  "doppler_logging_endpoint": "wss://doppler.local.maki.lol:443",
  "api_version": "2.148.0",
  "osbapi_version": "2.15",
  "routing_endpoint": "https://api.local.maki.lol/routing"
}
```

### Cloud Foundryにログイン

早速Cloud Foundryにログインしてみます。

`admin`ユーザーのパスワードは`bosh int /tmp/cf-values.yml --path /cf_admin_password`で取得できます。


次のコマンドでログインします。

```
cf login -a api.local.maki.lol -u admin -p $(bosh int /tmp/cf-values.yml --path /cf_admin_password) --skip-ssl-validation
```

次のようなログが出力されればOKです。

```
API endpoint: api.local.maki.lol

Authenticating...
OK

Targeted org system




API endpoint:   https://api.local.maki.lol (API version: 3.83.0)
User:           admin
Org:            system
Space:          No space targeted, use 'cf target -s SPACE'
```

Docker Imageをそのままデプロイできる機能を有効にします。

```
$ cf enable-feature-flag diego_docker
Setting status of diego_docker as admin...

OK

Feature diego_docker Enabled.
```

UAAにアクセスしてみます。URLは https://uaa.local.maki.lol です。

![image](https://user-images.githubusercontent.com/106908/79457457-36d37c00-802b-11ea-9e6c-c1000a91a9d8.png)


### Org、Spaceの作成

`demo` Orgと`demo` Spaceを作成します。

```
cf create-org demo
cf create-space demo -o demo
cf target -o demo -s demo
```

### Javaアプリケーションのデプロイ

Spring Bootのアプリをデプロイします。


雛形プロジェクトを作成し、ビルドします。

```
cd /tmp
curl https://start.spring.io/starter.tgz \
       -d artifactId=hello-cf \
       -d baseDir=hello-cf \
       -d dependencies=web,actuator \
       -d packageName=com.example \
       -d applicationName=HelloCfApplication | tar -xzvf -
cd hello-cf
./mvnw clean package -DskipTests=true
```


`cf push`します。

```
$ cf push hello -p target/hello-cf-0.0.1-SNAPSHOT.jar
Pushing app hello to org demo / space demo as admin...
Getting app info...
Creating app with these attributes...
+ name:       hello
  path:       /private/tmp/hello-cf/target/hello-cf-0.0.1-SNAPSHOT.jar
  routes:
+   hello.local.maki.lol

Creating app hello...
Mapping routes...
Comparing local files to remote cache...
Packaging files to upload...
Uploading files...
 315.39 KiB / 315.39 KiB [===========================================================================================================================================================] 100.00% 1s

Waiting for API to complete processing files...

Staging app and tracing logs...

Waiting for app to start...

name:                hello
requested state:     started
isolation segment:   placeholder
routes:              hello.local.maki.lol
last uploaded:       Thu 16 Apr 23:37:16 JST 2020
stack:               
buildpacks:          

type:           web
instances:      1/1
memory usage:   1024M
     state     since                  cpu    memory    disk      details
#0   running   2020-04-16T14:37:26Z   0.0%   0 of 1G   0 of 1G  
```

デプロイが成功しました。


`cf apps`コマンドでアプリケーション一覧を確認します。

```
$ cf apps
Getting apps in org demo / space demo as admin...
OK

name    requested state   instances   memory   disk   urls
hello   started           1/1         1G       1G     hello.local.maki.lol
```


`cf app`コマンドでアプリの詳細を確認できます。

```
$ cf app hello
Showing health and status for app hello in org demo / space demo as admin...

name:                hello
requested state:     started
isolation segment:   placeholder
routes:              hello.local.maki.lol
last uploaded:       Thu 16 Apr 23:37:16 JST 2020
stack:               
buildpacks:          

type:           web
instances:      1/1
memory usage:   1024M
     state     since                  cpu    memory    disk      details
#0   running   2020-04-16T14:37:26Z   0.0%   0 of 1G   0 of 1G   
```

`/actuator/health`エンドポイントにアクセスします。

```
$ curl hello.local.maki.lol/actuator/health
{"status":"UP"}
```

0.1.0ではHTTPエンドポイントだけ利用可能で、HTTPSやTCPは使えません。

また、これまでのCloud FoundryではBuildpack v2が使用されていましたが、cf-for-k8sでは[kpack](https://github.com/pivotal/kpack)経由で[Cloud Native Buildpacks](https://buildpacks.io/)が使用されます。

`cf push`で作成されたコンテナイメージはインストール時に設定したDocker Registryにデプロイされます。実際にDockerHubにイメージがデプロイされていました。

![image](https://user-images.githubusercontent.com/106908/79461235-d9422e00-8030-11ea-945d-fbbeddbb7a54.png)


なお、Kpackが使用するCloud Native Buildpacks一覧は`kubectl get builder -n cf-workloads-staging  cf-autodetect-builder -o yaml`で確認っできます。
現時点では言語として、Java, Node.js, .NET, Goが利用できます。


<details>
  <summary>実行例(クリックして確認)</summary>

```
$ kubectl get builder -n cf-workloads-staging  cf-autodetect-builder -o yaml

apiVersion: build.pivotal.io/v1alpha1
kind: Builder
metadata:
  annotations:
    kapp.k14s.io/identity: v1;cf-workloads-staging/build.pivotal.io/Builder/cf-autodetect-builder;build.pivotal.io/v1alpha1
    kapp.k14s.io/original: '{"apiVersion":"build.pivotal.io/v1alpha1","kind":"Builder","metadata":{"labels":{"kapp.k14s.io/app":"1587038509955244000","kapp.k14s.io/association":"v1.b67447296319bd9fc8db0f5d676d3fe0"},"name":"cf-autodetect-builder","namespace":"cf-workloads-staging"},"spec":{"image":"cloudfoundry/cnb:0.0.55-bionic"}}'
    kapp.k14s.io/original-diff: |
      - type: test
        path: /metadata/annotations
        value: {}
      - type: remove
        path: /metadata/annotations
    kapp.k14s.io/original-diff-full: ""
    kapp.k14s.io/original-diff-md5: c6e94dc94aed3401b5d0f26ed6c0bff3
  creationTimestamp: "2020-04-16T12:02:29Z"
  generation: 1
  labels:
    kapp.k14s.io/app: "1587038509955244000"
    kapp.k14s.io/association: v1.b67447296319bd9fc8db0f5d676d3fe0
  name: cf-autodetect-builder
  namespace: cf-workloads-staging
  resourceVersion: "5249"
  selfLink: /apis/build.pivotal.io/v1alpha1/namespaces/cf-workloads-staging/builders/cf-autodetect-builder
  uid: 00af0150-f0e7-46f6-9510-c53c430eb5fe
spec:
  image: cloudfoundry/cnb:0.0.55-bionic
status:
  builderMetadata:
  - id: org.cloudfoundry.openjdk
    version: v1.2.14
  - id: org.cloudfoundry.nodejs
    version: v2.0.4
  - id: org.cloudfoundry.distzip
    version: v1.1.12
  - id: org.cloudfoundry.tomcat
    version: v1.3.15
  - id: org.cloudfoundry.jdbc
    version: v1.1.12
  - id: org.cloudfoundry.googlestackdriver
    version: v1.1.11
  - id: org.cloudfoundry.archiveexpanding
    version: v1.0.102
  - id: org.cloudfoundry.buildsystem
    version: v1.2.14
  - id: org.cloudfoundry.debug
    version: v1.2.11
  - id: org.cloudfoundry.jmx
    version: v1.1.12
  - id: org.cloudfoundry.go
    version: v0.0.2
  - id: org.cloudfoundry.springautoreconfiguration
    version: v1.1.11
  - id: org.cloudfoundry.jvmapplication
    version: v1.1.12
  - id: org.cloudfoundry.springboot
    version: v1.2.13
  - id: org.cloudfoundry.procfile
    version: v1.1.12
  - id: org.cloudfoundry.dotnet-core
    version: v0.0.6
  - id: org.cloudfoundry.azureapplicationinsights
    version: v1.1.12
  - id: org.cloudfoundry.node-engine
    version: 0.0.158
  - id: org.cloudfoundry.npm
    version: 0.1.3
  - id: org.cloudfoundry.yarn
    version: 0.1.2
  - id: org.cloudfoundry.dep
    version: 0.0.89
  - id: org.cloudfoundry.go-compiler
    version: 0.0.83
  - id: org.cloudfoundry.go-mod
    version: 0.0.84
  - id: org.cloudfoundry.dotnet-core-aspnet
    version: 0.0.118
  - id: org.cloudfoundry.dotnet-core-build
    version: 0.0.68
  - id: org.cloudfoundry.dotnet-core-conf
    version: 0.0.115
  - id: org.cloudfoundry.dotnet-core-runtime
    version: 0.0.127
  - id: org.cloudfoundry.dotnet-core-sdk
    version: 0.0.122
  - id: org.cloudfoundry.icu
    version: 0.0.43
  - id: org.cloudfoundry.node-engine
    version: 0.0.158
  conditions:
  - lastTransitionTime: "2020-04-16T12:02:41Z"
    status: "True"
    type: Ready
  latestImage: index.docker.io/cloudfoundry/cnb@sha256:0a718640a4bde8ff65eb00e891ff7f4f23ffd9a0af44d43f6033cc5809768945
  observedGeneration: 1
  stack:
    id: io.buildpacks.stacks.bionic
    runImage: index.docker.io/cloudfoundry/run@sha256:bfe49e7d1c2c47d980af9dd684047616db872a982dcb2c5515a960d1a962a599
```
</details>


`cf logs`コマンドでログを確認できます。Cloud Native Buildpacksの実行結果が出力されています。

```
$ cf logs hello --recent
Retrieving logs for app hello in org demo / space demo as admin...


   2020-04-16T22:19:07.89+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT prepare:fetch.go:74: Successfully downloaded cf-blobstore-minio.cf-blobstore.svc.cluster.local:9000/cc-packages/1e/a3/1ea39ef8-a5cb-4b97-ba5a-9e8d53ed20c2 in path "/workspace"
   2020-04-16T22:19:09.41+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT 6 of 13 buildpacks participating
   2020-04-16T22:19:09.41+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT org.cloudfoundry.openjdk                   v1.2.14
   2020-04-16T22:19:09.41+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT org.cloudfoundry.jvmapplication            v1.1.12
   2020-04-16T22:19:09.41+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT org.cloudfoundry.tomcat                    v1.3.15
   2020-04-16T22:19:09.41+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT org.cloudfoundry.springboot                v1.2.13
   2020-04-16T22:19:09.41+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT org.cloudfoundry.distzip                   v1.1.12
   2020-04-16T22:19:09.41+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT org.cloudfoundry.springautoreconfiguration v1.1.11
   2020-04-16T22:19:13.56+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Warning: Image "making/1ea39ef8-a5cb-4b97-ba5a-9e8d53ed20c2" not found
   2020-04-16T22:19:16.19+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Cloud Foundry OpenJDK Buildpack v1.2.14
   2020-04-16T22:19:16.19+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT OpenJDK JRE 11.0.6: Contributing to layer
   2020-04-16T22:19:16.19+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Downloading from https://github.com/AdoptOpenJDK/openjdk11-binaries/releases/download/jdk-11.0.6%!B(MISSING)10/OpenJDK11U-jre_x64_linux_hotspot_11.0.6_10.tar.gz
   2020-04-16T22:19:22.11+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Verifying checksum
   2020-04-16T22:19:22.29+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Expanding to /layers/org.cloudfoundry.openjdk/openjdk-jre
   2020-04-16T22:19:24.71+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Writing JAVA_HOME to shared
   2020-04-16T22:19:24.71+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Writing MALLOC_ARENA_MAX to shared
   2020-04-16T22:19:24.71+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Writing .profile.d/active-processor-count
   2020-04-16T22:19:24.71+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Java Security Properties v1.2.14: Contributing to layer
   2020-04-16T22:19:24.71+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Writing JAVA_OPTS to launch
   2020-04-16T22:19:24.71+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Security Provider Configurer v1.2.14: Contributing to layer
   2020-04-16T22:19:24.72+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Writing .profile.d/security-provider-classpath
   2020-04-16T22:19:24.72+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Writing .profile.d/security-provider-configurer
   2020-04-16T22:19:24.72+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Link-Local DNS v1.2.14: Contributing to layer
   2020-04-16T22:19:24.72+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Writing .profile.d/link-local-dns
   2020-04-16T22:19:24.72+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT JVMKill Agent 1.16.0: Contributing to layer
   2020-04-16T22:19:24.72+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Downloading from https://java-buildpack.cloudfoundry.org/jvmkill/bionic/x86_64/jvmkill-1.16.0-RELEASE.so
   2020-04-16T22:19:24.89+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Verifying checksum
   2020-04-16T22:19:24.91+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Copying to /layers/org.cloudfoundry.openjdk/jvmkill
   2020-04-16T22:19:24.91+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Writing JAVA_OPTS to shared
   2020-04-16T22:19:24.91+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Class Counter v1.2.14: Contributing to layer
   2020-04-16T22:19:24.92+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Memory Calculator 4.0.0: Contributing to layer
   2020-04-16T22:19:24.92+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Downloading from https://java-buildpack.cloudfoundry.org/memory-calculator/bionic/x86_64/memory-calculator-4.0.0.tgz
   2020-04-16T22:19:25.01+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Verifying checksum
   2020-04-16T22:19:25.02+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Set $BPL_HEAD_ROOM to configure. Default 0
   2020-04-16T22:19:25.02+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Set $BPL_LOADED_CLASS_COUNT to configure. Default 35%!!(MISSING)o(MISSING)f classes
   2020-04-16T22:19:25.02+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Set $BPL_THREAD_COUNT to configure. Default 250
   2020-04-16T22:19:25.02+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Expanding to /layers/org.cloudfoundry.openjdk/memory-calculator
   2020-04-16T22:19:25.06+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Writing .profile.d/memory-calculator
   2020-04-16T22:19:25.09+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Cloud Foundry JVM Application Buildpack v1.1.12
   2020-04-16T22:19:25.09+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Executable JAR: Contributing to layer
   2020-04-16T22:19:25.09+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Writing CLASSPATH to shared
   2020-04-16T22:19:25.09+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Process types:
   2020-04-16T22:19:25.09+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT executable-jar: java -cp $CLASSPATH $JAVA_OPTS org.springframework.boot.loader.JarLauncher
   2020-04-16T22:19:25.09+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT task:           java -cp $CLASSPATH $JAVA_OPTS org.springframework.boot.loader.JarLauncher
   2020-04-16T22:19:25.09+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT web:            java -cp $CLASSPATH $JAVA_OPTS org.springframework.boot.loader.JarLauncher
   2020-04-16T22:19:25.12+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Cloud Foundry Spring Boot Buildpack v1.2.13
   2020-04-16T22:19:25.12+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Spring Boot 2.2.6.RELEASE: Contributing to layer
   2020-04-16T22:19:25.12+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Writing CLASSPATH to shared
   2020-04-16T22:19:25.13+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT 5 application slices
   2020-04-16T22:19:25.13+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Process types:
   2020-04-16T22:19:25.13+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT spring-boot: java -cp $CLASSPATH $JAVA_OPTS com.example.HelloCfApplication
   2020-04-16T22:19:25.13+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT task:        java -cp $CLASSPATH $JAVA_OPTS com.example.HelloCfApplication
   2020-04-16T22:19:25.13+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT web:         java -cp $CLASSPATH $JAVA_OPTS com.example.HelloCfApplication
   2020-04-16T22:19:25.23+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Cloud Foundry Spring Auto-reconfiguration Buildpack v1.1.11
   2020-04-16T22:19:25.23+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Spring Auto-reconfiguration 2.11.0: Contributing to layer
   2020-04-16T22:19:25.23+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Downloading from https://repo.spring.io/release/org/cloudfoundry/java-buildpack-auto-reconfiguration/2.11.0.RELEASE/java-buildpack-auto-reconfiguration-2.11.0.RELEASE.jar
   2020-04-16T22:19:26.65+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Verifying checksum
   2020-04-16T22:19:26.67+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Copying to /layers/org.cloudfoundry.springautoreconfiguration/auto-reconfiguration
   2020-04-16T22:19:26.68+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT     Writing CLASSPATH to launch
   2020-04-16T22:19:31.48+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding layer 'launcher'
   2020-04-16T22:19:32.55+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding layer 'org.cloudfoundry.openjdk:class-counter'
   2020-04-16T22:19:32.82+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding layer 'org.cloudfoundry.openjdk:java-security-properties'
   2020-04-16T22:19:32.86+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding layer 'org.cloudfoundry.openjdk:jvmkill'
   2020-04-16T22:19:33.26+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding layer 'org.cloudfoundry.openjdk:link-local-dns'
   2020-04-16T22:19:33.63+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding layer 'org.cloudfoundry.openjdk:memory-calculator'
   2020-04-16T22:19:35.06+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding layer 'org.cloudfoundry.openjdk:openjdk-jre'
   2020-04-16T22:19:48.75+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding layer 'org.cloudfoundry.openjdk:security-provider-configurer'
   2020-04-16T22:19:49.62+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding layer 'org.cloudfoundry.jvmapplication:executable-jar'
   2020-04-16T22:19:49.66+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding layer 'org.cloudfoundry.springboot:spring-boot'
   2020-04-16T22:19:49.70+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding layer 'org.cloudfoundry.springautoreconfiguration:auto-reconfiguration'
   2020-04-16T22:19:52.14+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding 6/6 app layer(s)
   2020-04-16T22:19:52.14+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding layer 'config'
   2020-04-16T22:20:44.31+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT *** Images (sha256:9204851d2b37b7d2b50e6141ab47da0ddfc268181d243ba5343fbbb53c1d41a9):
   2020-04-16T22:20:44.31+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT making/1ea39ef8-a5cb-4b97-ba5a-9e8d53ed20c2
   2020-04-16T22:20:44.31+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT index.docker.io/making/1ea39ef8-a5cb-4b97-ba5a-9e8d53ed20c2:b1.20200416.131901
   2020-04-16T22:20:44.32+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding cache layer 'org.cloudfoundry.jvmapplication:executable-jar'
   2020-04-16T22:20:44.32+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Adding cache layer 'org.cloudfoundry.springboot:spring-boot'
   2020-04-16T22:20:45.56+0900 [/7700619a-7c20-4081-9aba-7bf764a12670] OUT Build successful
   2020-04-16T22:20:51.16+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT Environment:
   2020-04-16T22:20:51.16+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT ------------
   .. (略) ..
   2020-04-16T22:20:54.97+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16T13:20:54.971025Z	info	Envoy command: [-c /etc/istio/proxy/envoy-rev0.json --restart-epoch 0 --drain-time-s 45 --parent-shutdown-time-s 60 --service-cluster hello-demo-76752befbe.cf-workloads --service-node sidecar~10.244.0.64~hello-demo-76752befbe-0.cf-workloads~cf-workloads.svc.cluster.local --max-obj-name-len 189 --local-address-ip-version v4 --log-format [Envoy (Epoch 0)] [%Y-%m-%d %T.%e][%t][%l][%n] %v -l warning --component-log-level misc:error --concurrency 2]
   2020-04-16T22:20:55.01+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT [Envoy (Epoch 0)] [2020-04-16 13:20:55.017][20][warning][config] [bazel-out/k8-opt/bin/external/envoy/source/common/config/_virtual_includes/grpc_stream_lib/common/config/grpc_stream.h:91] gRPC config stream closed: 14, no healthy upstream
   2020-04-16T22:20:55.01+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT [Envoy (Epoch 0)] [2020-04-16 13:20:55.017][20][warning][config] [bazel-out/k8-opt/bin/external/envoy/source/common/config/_virtual_includes/grpc_stream_lib/common/config/grpc_stream.h:54] Unable to establish new stream
   2020-04-16T22:20:55.53+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16T13:20:55.533350Z	info	Envoy proxy is ready
   2020-04-16T22:20:56.51+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT .   ____          _            __ _ _
   2020-04-16T22:20:56.51+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
   2020-04-16T22:20:56.51+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT ( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
   2020-04-16T22:20:56.51+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
   2020-04-16T22:20:56.51+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT '  |____| .__|_| |_|_| |_\__, | / / / /
   2020-04-16T22:20:56.51+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT =========|_|==============|___/=/_/_/_/
   2020-04-16T22:20:56.51+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT :: Spring Boot ::        (v2.2.6.RELEASE)
   2020-04-16T22:20:56.73+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16 13:20:56.732  INFO 1 --- [           main] pertySourceApplicationContextInitializer : 'cloud' property source added
   2020-04-16T22:20:56.73+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16 13:20:56.737  INFO 1 --- [           main] nfigurationApplicationContextInitializer : Reconfiguration enabled
   2020-04-16T22:20:56.75+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16 13:20:56.750  INFO 1 --- [           main] com.example.HelloCfApplication           : Starting HelloCfApplication on hello-demo-76752befbe-0 with PID 1 (/workspace/BOOT-INF/classes started by cnb in /workspace)
   2020-04-16T22:20:56.75+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16 13:20:56.751  INFO 1 --- [           main] com.example.HelloCfApplication           : The following profiles are active: cloud
   2020-04-16T22:20:58.45+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16 13:20:58.453  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)
   2020-04-16T22:20:58.47+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16 13:20:58.476  INFO 1 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
   2020-04-16T22:20:58.47+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16 13:20:58.477  INFO 1 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.33]
   2020-04-16T22:20:58.58+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16 13:20:58.584  INFO 1 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
   2020-04-16T22:20:58.58+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16 13:20:58.584  INFO 1 --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 1772 ms
   2020-04-16T22:20:59.03+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16 13:20:59.029  INFO 1 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService 'applicationTaskExecutor'
   2020-04-16T22:20:59.33+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16 13:20:59.330  INFO 1 --- [           main] o.s.b.a.e.web.EndpointLinksResolver      : Exposing 2 endpoint(s) beneath base path '/actuator'
   2020-04-16T22:20:59.43+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16 13:20:59.438  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path ''
   2020-04-16T22:20:59.44+0900 [/7856e5a8-05c4-46f8-a526-1dd4555f9869] OUT 2020-04-16 13:20:59.443  INFO 1 --- [           main] com.example.HelloCfApplication           : Started HelloCfApplication in 3.747 seconds (JVM running for 4.818)
```

cf-for-k8sでは、EiriniというコンポーネントがCloud Controllerからのリクエストを受けてKubernetesにアプリを`Statefulset`としてデプロイします。Eiriniが作成した`StatefulSet`及び、それにより作られた`Pod`は次のコマンドで確認できます。

```
$ kubectl get statefulset,pod -n cf-workloads
NAME                                     READY   AGE
statefulset.apps/hello-demo-76752befbe   1/1     4m55s

NAME                          READY   STATUS    RESTARTS   AGE
pod/hello-demo-76752befbe-0   2/2     Running   0          4m55s
```

> 現時点でcf-for-k8sでDeveloper(`cf push`を使うユーザー)が`kubectl`を使うことは想定していません。`kubectl`はPlatformエンジニアが使う想定です。

### Smoke Testの実行

`cf push`は成功しましたが、インストールが適切にできているか確認するために、Smoke Testを実行してみます。
Smoke Testを実行するには[ginkgo](https://github.com/onsi/ginkgo)をインストールする必要があります。

```
brew install go
go get -u github.com/onsi/ginkgo/ginkgo
export PATH=$PATH:$HOME/go/bin
```

次のコマンドでSmoke Testを実行します。

```
export SMOKE_TEST_APPS_DOMAIN=local.maki.lol
export SMOKE_TEST_API_ENDPOINT=api.local.maki.lol
export SMOKE_TEST_USERNAME=admin
export SMOKE_TEST_PASSWORD=$(bosh int /tmp/cf-values.yml --path /cf_admin_password)
export SMOKE_TEST_SKIP_SSL=true
./cf-for-k8s/hack/run-smoke-tests.sh
```

次のような結果が出力されれば成功です。


<details>
  <summary>実行例(クリックして確認)</summary>

```
Running Suite: Smoke Tests Suite
================================
Random Seed: 1587047286
Will run 2 of 2 specs

Smoke Tests when running cf push 
  creates a routable app pod in Kubernetes from a docker image-based app
  /Users/toshiaki/git/cf-for-k8s/tests/smoke/smoke_test.go:81

[2020-04-16 14:28:07.85 (UTC)]> cf api api.local.maki.lol --skip-ssl-validation 
Setting api endpoint to api.local.maki.lol...
OK

api endpoint:   https://api.local.maki.lol
api version:    3.83.0

[2020-04-16 14:28:07.90 (UTC)]> cf auth admin [REDACTED] 
SILENCING COMMAND OUTPUT
[2020-04-16 14:28:08.62 (UTC)]> cf create-org cf-for-k8s-smoke-1-org-7276a55c59cbad3e 
Creating org cf-for-k8s-smoke-1-org-7276a55c59cbad3e as admin...
OK

Assigning role OrgManager to user admin in org cf-for-k8s-smoke-1-org-7276a55c59cbad3e...
OK

TIP: Use 'cf target -o "cf-for-k8s-smoke-1-org-7276a55c59cbad3e"' to target new org

[2020-04-16 14:28:08.85 (UTC)]> cf create-space -o cf-for-k8s-smoke-1-org-7276a55c59cbad3e cf-for-k8s-smoke-1-space-6ddfc190c1c2c804 
Creating space cf-for-k8s-smoke-1-space-6ddfc190c1c2c804 in org cf-for-k8s-smoke-1-org-7276a55c59cbad3e as admin...
OK

Assigning role SpaceManager to user admin in org cf-for-k8s-smoke-1-org-7276a55c59cbad3e / space cf-for-k8s-smoke-1-space-6ddfc190c1c2c804 as admin...
OK

Assigning role SpaceDeveloper to user admin in org cf-for-k8s-smoke-1-org-7276a55c59cbad3e / space cf-for-k8s-smoke-1-space-6ddfc190c1c2c804 as admin...
OK

TIP: Use 'cf target -o "cf-for-k8s-smoke-1-org-7276a55c59cbad3e" -s "cf-for-k8s-smoke-1-space-6ddfc190c1c2c804"' to target new space

[2020-04-16 14:28:09.30 (UTC)]> cf target -o cf-for-k8s-smoke-1-org-7276a55c59cbad3e -s cf-for-k8s-smoke-1-space-6ddfc190c1c2c804 
api endpoint:   https://api.local.maki.lol
api version:    2.148.0
user:           admin
org:            cf-for-k8s-smoke-1-org-7276a55c59cbad3e
space:          cf-for-k8s-smoke-1-space-6ddfc190c1c2c804

[2020-04-16 14:28:09.45 (UTC)]> cf enable-feature-flag diego_docker 
Setting status of diego_docker as admin...

OK

Feature diego_docker Enabled.
STEP: pushing an app and checking that the CF CLI command succeeds

[2020-04-16 14:28:09.53 (UTC)]> cf push cf-for-k8s-smoke-1-app-3b66c142cb33e749 -o cloudfoundry/diego-docker-app 
Pushing app cf-for-k8s-smoke-1-app-3b66c142cb33e749 to org cf-for-k8s-smoke-1-org-7276a55c59cbad3e / space cf-for-k8s-smoke-1-space-6ddfc190c1c2c804 as admin...
Getting app info...
Creating app with these attributes...
+ name:           cf-for-k8s-smoke-1-app-3b66c142cb33e749
+ docker image:   cloudfoundry/diego-docker-app
  routes:
+   cf-for-k8s-smoke-1-app-3b66c142cb33e749.local.maki.lol

Creating app cf-for-k8s-smoke-1-app-3b66c142cb33e749...
Mapping routes...

Staging app and tracing logs...

Waiting for app to start...

name:                cf-for-k8s-smoke-1-app-3b66c142cb33e749
requested state:     started
isolation segment:   placeholder
routes:              cf-for-k8s-smoke-1-app-3b66c142cb33e749.local.maki.lol
last uploaded:       Thu 16 Apr 23:28:10 JST 2020
stack:               
docker image:        cloudfoundry/diego-docker-app

type:           web
instances:      1/1
memory usage:   1024M
     state     since                  cpu    memory    disk      details
#0   running   2020-04-16T14:28:10Z   0.0%   0 of 1G   0 of 1G   

STEP: querying the app
STEP: verifying that the application's logs are available.

[2020-04-16 14:28:29.54 (UTC)]> cf logs cf-for-k8s-smoke-1-app-3b66c142cb33e749 --recent 
Retrieving logs for app cf-for-k8s-smoke-1-app-3b66c142cb33e749 in org cf-for-k8s-smoke-1-org-7276a55c59cbad3e / space cf-for-k8s-smoke-1-space-6ddfc190c1c2c804 as admin...

   2020-04-16T23:28:14.53+0900 [/a2dd2da5-7049-4784-8e6b-18431ce70a02] OUT Environment:
   2020-04-16T23:28:14.53+0900 [/a2dd2da5-7049-4784-8e6b-18431ce70a02] OUT ------------
   ....
   2020-04-16T23:28:19.30+0900 [/a2dd2da5-7049-4784-8e6b-18431ce70a02] OUT Hello World from index '0'
   2020-04-16T23:28:20.62+0900 [/a2dd2da5-7049-4784-8e6b-18431ce70a02] OUT 2020-04-16T14:28:20.628396Z	info	Envoy proxy is ready

[2020-04-16 14:28:29.80 (UTC)]> cf delete-org cf-for-k8s-smoke-1-org-7276a55c59cbad3e -f 
Deleting org cf-for-k8s-smoke-1-org-7276a55c59cbad3e as admin...
OK


• [SLOW TEST:25.108 seconds]
Smoke Tests
/Users/toshiaki/git/cf-for-k8s/tests/smoke/smoke_test.go:30
  when running cf push
  /Users/toshiaki/git/cf-for-k8s/tests/smoke/smoke_test.go:31
    creates a routable app pod in Kubernetes from a docker image-based app
    /Users/toshiaki/git/cf-for-k8s/tests/smoke/smoke_test.go:81
------------------------------
Smoke Tests when running cf push 
  creates a routable app pod in Kubernetes from a source-based app
  /Users/toshiaki/git/cf-for-k8s/tests/smoke/smoke_test.go:119

[2020-04-16 14:28:32.96 (UTC)]> cf api api.local.maki.lol --skip-ssl-validation 
Setting api endpoint to api.local.maki.lol...
OK

api endpoint:   https://api.local.maki.lol
api version:    3.83.0

[2020-04-16 14:28:33.02 (UTC)]> cf auth admin [REDACTED] 
SILENCING COMMAND OUTPUT
[2020-04-16 14:28:33.32 (UTC)]> cf create-org cf-for-k8s-smoke-1-org-0b6c52e41d3995f2 
Creating org cf-for-k8s-smoke-1-org-0b6c52e41d3995f2 as admin...
OK

Assigning role OrgManager to user admin in org cf-for-k8s-smoke-1-org-0b6c52e41d3995f2...
OK

TIP: Use 'cf target -o "cf-for-k8s-smoke-1-org-0b6c52e41d3995f2"' to target new org

[2020-04-16 14:28:33.56 (UTC)]> cf create-space -o cf-for-k8s-smoke-1-org-0b6c52e41d3995f2 cf-for-k8s-smoke-1-space-745fbfdb5c7c7828 
Creating space cf-for-k8s-smoke-1-space-745fbfdb5c7c7828 in org cf-for-k8s-smoke-1-org-0b6c52e41d3995f2 as admin...
OK

Assigning role SpaceManager to user admin in org cf-for-k8s-smoke-1-org-0b6c52e41d3995f2 / space cf-for-k8s-smoke-1-space-745fbfdb5c7c7828 as admin...
OK

Assigning role SpaceDeveloper to user admin in org cf-for-k8s-smoke-1-org-0b6c52e41d3995f2 / space cf-for-k8s-smoke-1-space-745fbfdb5c7c7828 as admin...
OK

TIP: Use 'cf target -o "cf-for-k8s-smoke-1-org-0b6c52e41d3995f2" -s "cf-for-k8s-smoke-1-space-745fbfdb5c7c7828"' to target new space

[2020-04-16 14:28:34.03 (UTC)]> cf target -o cf-for-k8s-smoke-1-org-0b6c52e41d3995f2 -s cf-for-k8s-smoke-1-space-745fbfdb5c7c7828 
api endpoint:   https://api.local.maki.lol
api version:    2.148.0
user:           admin
org:            cf-for-k8s-smoke-1-org-0b6c52e41d3995f2
space:          cf-for-k8s-smoke-1-space-745fbfdb5c7c7828

[2020-04-16 14:28:34.18 (UTC)]> cf disable-feature-flag diego_docker 
Setting status of diego_docker as admin...

OK

Feature diego_docker Disabled.
STEP: pushing an app and checking that the CF CLI command succeeds

[2020-04-16 14:28:34.24 (UTC)]> cf push cf-for-k8s-smoke-1-app-8c8ef77b0a1fde83 -p assets/test-node-app 
Pushing app cf-for-k8s-smoke-1-app-8c8ef77b0a1fde83 to org cf-for-k8s-smoke-1-org-0b6c52e41d3995f2 / space cf-for-k8s-smoke-1-space-745fbfdb5c7c7828 as admin...
Getting app info...
Creating app with these attributes...
+ name:       cf-for-k8s-smoke-1-app-8c8ef77b0a1fde83
  path:       /Users/toshiaki/git/cf-for-k8s/tests/smoke/assets/test-node-app
  routes:
+   cf-for-k8s-smoke-1-app-8c8ef77b0a1fde83.local.maki.lol

Creating app cf-for-k8s-smoke-1-app-8c8ef77b0a1fde83...
Mapping routes...
Comparing local files to remote cache...
Packaging files to upload...
Uploading files...
 530 B / 530 B [=====================================================================================================================================================================] 100.00% 1s

Waiting for API to complete processing files...

Staging app and tracing logs...

Waiting for app to start...

name:                cf-for-k8s-smoke-1-app-8c8ef77b0a1fde83
requested state:     started
isolation segment:   placeholder
routes:              cf-for-k8s-smoke-1-app-8c8ef77b0a1fde83.local.maki.lol
last uploaded:       Thu 16 Apr 23:29:34 JST 2020
stack:               
buildpacks:          

type:           web
instances:      1/1
memory usage:   1024M
     state     since                  cpu    memory    disk      details
#0   running   2020-04-16T14:29:41Z   0.0%   0 of 1G   0 of 1G   

STEP: querying the app
STEP: verifying that the application's logs are available.

[2020-04-16 14:30:00.71 (UTC)]> cf logs cf-for-k8s-smoke-1-app-8c8ef77b0a1fde83 --recent 
Retrieving logs for app cf-for-k8s-smoke-1-app-8c8ef77b0a1fde83 in org cf-for-k8s-smoke-1-org-0b6c52e41d3995f2 / space cf-for-k8s-smoke-1-space-745fbfdb5c7c7828 as admin...

   2020-04-16T23:28:44.65+0900 [/167249bc-f9fb-4ab6-8dda-567a4916712a] OUT prepare:fetch.go:74: Successfully downloaded cf-blobstore-minio.cf-blobstore.svc.cluster.local:9000/cc-packages/8e/0e/8e0ec74a-caf0-4a94-bc0b-72b477b90412 in path "/workspace"
   2020-04-16T23:28:45.52+0900 [/167249bc-f9fb-4ab6-8dda-567a4916712a] OUT org.cloudfoundry.node-engine 0.0.158
   ....
   2020-04-16T23:29:50.50+0900 [/8689129b-6af6-4a74-8689-483f6440c35a] OUT Console output from test-node-app
   2020-04-16T23:29:52.16+0900 [/8689129b-6af6-4a74-8689-483f6440c35a] OUT 2020-04-16T14:29:52.160166Z	info	Envoy proxy is ready

[2020-04-16 14:30:01.16 (UTC)]> cf delete-org cf-for-k8s-smoke-1-org-0b6c52e41d3995f2 -f 
Deleting org cf-for-k8s-smoke-1-org-0b6c52e41d3995f2 as admin...
OK


• [SLOW TEST:94.392 seconds]
Smoke Tests
/Users/toshiaki/git/cf-for-k8s/tests/smoke/smoke_test.go:30
  when running cf push
  /Users/toshiaki/git/cf-for-k8s/tests/smoke/smoke_test.go:31
    creates a routable app pod in Kubernetes from a source-based app
    /Users/toshiaki/git/cf-for-k8s/tests/smoke/smoke_test.go:119
------------------------------

Ran 2 of 2 Specs in 119.501 seconds
SUCCESS! -- 2 Passed | 0 Failed | 0 Pending | 0 Skipped
PASS

Ginkgo ran 1 suite in 2m0.870246904s
Test Suite Passed
```
</details>


---

cf-for-k8s 0.1.0を試しました。

まだまだ制限は多く、Productionで利用できるレベルではないですが、少しずつ機能が追加されていくでしょう。
現時点でのKnown Issuesは次のページに記載されています。

https://github.com/cloudfoundry/cf-for-k8s/releases/tag/v0.1.0
