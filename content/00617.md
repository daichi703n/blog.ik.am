---
title: Cloud Native Buildpacks Tutorial - X. Tanzu Build ServiceでCloud Native Builpacksを実行
tags: ["Cloud Native Buildpacks Tutorial", "Cloud Native Buildpacks", "Tanzu Build Service", "Series"]
categories: ["Dev", "Infrastructure", "CloudNativeBuildpacks", "TBS"]
---

VMware Tanzu Build Service 0.1.0を使用します。

**目次**
<!-- toc -->

### Pivotal Networkからダウンロード

https://network.pivotal.io/products/build-service#/releases/612454

* `build-service-bundle.tgz`
* `pb-cli-macos`
* `duffle-cli-macos`

をダウンロードします。

`pivnet` CLIを使う場合は

```
pivnet download-product-files --product-slug='build-service' --release-version='0.1.0' --product-file-id=648378
pivnet download-product-files --product-slug='build-service' --release-version='0.1.0' --product-file-id=648384
pivnet download-product-files --product-slug='build-service' --release-version='0.1.0' --product-file-id=648381
```

```
chmod +x pb-0.1.0-darwin
chmod +x duffle-0.1.0-darwin
mv pb-0.1.0-darwin /usr/local/bin/pb
mv duffle-0.1.0-darwin /usr/local/bin/duffle
```


### Credentialsファイルの作成

```
mkdir -p ${HOME}/.tbs
DOCKER_REGISTRY_HOSTNAME=docker.pkg.github.com
DOCKER_REGISTRY_PORT=443

openssl s_client -showcerts -connect $DOCKER_REGISTRY_HOSTNAME:$DOCKER_REGISTRY_PORT </dev/null 2>/dev/null | openssl x509 -outform PEM >  ${HOME}/.tbs/docker_registry_ca.pem
```

```
cat <<EOF > ${HOME}/.tbs/credentials.yml
name: build-service-credentials
credentials:
 - name: kube_config
   source:
     path: "${HOME}/.kube/config"
   destination:
     path: "/root/.kube/config"
 - name: ca_cert
   source:
     path: "${HOME}/.tbs/docker_registry_ca.pem"
   destination:
     path: "/cnab/app/cert/ca.crt"
EOF
```
### Relocation

```
cat ~/github-access-token.txt | docker login docker.pkg.github.com -u making --password-stdin
```

```
duffle relocate -f ./build-service-0.1.0.tgz -m ./relocated.json -p docker.pkg.github.com/making/tanzu
```

```
duffle install tanzu-build-service -c ${HOME}/.tbs/credentials.yml  \
    --set kubernetes_env=docker-desktop \
    --set docker_registry=docker.pkg.github.com \
    --set docker_repository=making/tanzu \
    --set registry_username=making \
    --set registry_password=$(cat ~/github-access-token.txt) \
    --set custom_builder_image=docker.pkg.github.com/making/tanzu/default-builder \
    -f ./build-service-0.1.0.tgz \
    -m ./relocated.json
```

### Duffle CLIのインストール

```
wget -O duffle https://github.com/cnabio/duffle/releases/download/0.3.5-beta.1/duffle-darwin-amd64
chmod +x duffle
mv duffle /usr/local/bin
```