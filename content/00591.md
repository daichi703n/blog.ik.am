---
title: Cloud Native Buildpacks Tutorial - 3.2. L gcr.io/paketo-buildpacks/builder:full-cf BuilderでJavaアプリ(Spring Boot)のOCIイメージを作成
tags: ["Cloud Native Buildpacks Tutorial", "Cloud Native Buildpacks", "Paketo", "Series"]
categories: ["Dev", "Infrastructure", "CloudNativeBuildpacks", "Paketo"]
---

`gcr.io/paketo-buildpacks/builder:full-cf`でJava(Spring Boot)のアプリケーションのOCIイメージを作成します。

BuilderとStackを予めpullしておいてください。

```
docker pull gcr.io/paketo-buildpacks/builder:full-cf
docker pull gcr.io/paketo-buildpacks/run:full-cnb-cf
```

次のコマンドで"Hello World"アプリケーションを作成します。

```
curl https://start.spring.io/starter.tgz \
       -d artifactId=hello-spring-boot \
       -d baseDir=hello-spring-boot \
       -d dependencies=webflux \
       -d packageName=hello \
       -d applicationName=HelloSpringBootApplication | tar -xzvf -

cd hello-spring-boot
cat <<'EOF' > src/main/java/hello/HelloSpringBootApplication.java
package hello;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@SpringBootApplication
@RestController
public class HelloSpringBootApplication {
	
	@GetMapping("/") 
	public String hello() {
		return "Hello World!";
	}

	public static void main(String[] args) {
		SpringApplication.run(HelloSpringBootApplication.class, args);
	}

}
EOF
```

`pack build`コマンドでイメージを作成します。

Javaの場合はソースからビルドする方法とjar/warファイルからビルドする方法があります。

### ソースからビルドする場合

```
pack build making/pack-spring-boot --no-pull --builder gcr.io/paketo-buildpacks/builder:full-cf
```

> BuilderとStackを事前にpullしていない場合は`--no-pull`を外せば、ビルド時にBuilderとStackもpullしますが、ビルドが遅くなります。

次のようなログが出力されます。

```
===> DETECTING
[detector] 6 of 11 buildpacks participating
[detector] paketo-buildpacks/bellsoft-liberica 2.3.1
[detector] paketo-buildpacks/build-system      1.2.0
[detector] paketo-buildpacks/executable-jar    1.2.1
[detector] paketo-buildpacks/apache-tomcat     1.1.1
[detector] paketo-buildpacks/spring-boot       1.5.1
[detector] paketo-buildpacks/dist-zip          1.2.1
===> ANALYZING
[analyzer] Previous image with name "index.docker.io/making/pack-spring-boot:latest" not found
===> RESTORING
===> BUILDING
[builder] 
[builder] Paketo BellSoft Liberica Buildpack 2.3.1
[builder]     Set $BP_JAVA_VERSION to configure the Java version. Default 11.*.
[builder]     Set $BPL_HEAD_ROOM to configure the headroom in memory calculation. Default 0.
[builder]     Set $BPL_LOADED_CLASS_COUNT to configure the number of loaded classes in memory calculation. Default 35% of classes.
[builder]     Set $BPL_THREAD_COUNT to configure the number of threads in memory calculation. Default 250.
[builder]   BellSoft Liberica JDK 11.0.7: Contributing to layer
[builder]     Downloading from https://github.com/bell-sw/Liberica/releases/download/11.0.7+10/bellsoft-jdk11.0.7+10-linux-amd64.tar.gz
[builder]     Verifying checksum
[builder]     Expanding to /layers/paketo-buildpacks_bellsoft-liberica/jdk
[builder]     Writing env.build/JAVA_HOME.override
[builder]     Writing env.build/JDK_HOME.override
[builder]   BellSoft Liberica JRE 11.0.7: Contributing to layer
[builder]     Downloading from https://github.com/bell-sw/Liberica/releases/download/11.0.7+10/bellsoft-jre11.0.7+10-linux-amd64.tar.gz
[builder]     Verifying checksum
[builder]     Expanding to /layers/paketo-buildpacks_bellsoft-liberica/jre
[builder]     Writing env/JAVA_HOME.override
[builder]     Writing env/MALLOC_ARENA_MAX.override
[builder]     Writing profile.d/active-processor-count.sh
[builder]   JVMKill Agent 1.16.0: Contributing to layer
[builder]     Downloading from https://github.com/cloudfoundry/jvmkill/releases/download/v1.16.0.RELEASE/jvmkill-1.16.0-RELEASE.so
[builder]     Verifying checksum
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/jvmkill
[builder]     Writing env/JAVA_OPTS.append
[builder]   Link-Local DNS: Contributing to layer
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/link-local-dns
[builder]     Writing profile.d/link-local-dns.sh
[builder]   Memory Calculator 4.0.0: Contributing to layer
[builder]     Downloading from https://github.com/cloudfoundry/java-buildpack-memory-calculator/releases/download/v4.0.0/memory-calculator-4.0.0.tgz
[builder]     Verifying checksum
[builder]     Expanding to /layers/paketo-buildpacks_bellsoft-liberica/memory-calculator
[builder]     Writing profile.d/memory-calculator.sh
[builder]   Class Counter: Contributing to layer
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/class-counter
[builder]   Java Security Properties: Contributing to layer
[builder]     Writing env.launch/JAVA_OPTS.append
[builder]     Writing env.launch/JAVA_SECURITY_PROPERTIES.override
[builder]   Security Providers Configurer: Contributing to layer
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/security-providers-configurer
[builder]     Writing profile.d/security-providers-classpath.sh
[builder]     Writing profile.d/security-providers-configurer.sh
[builder] 
[builder] Paketo Build System Buildpack 1.2.0
[builder]     Set $BP_BUILD_ARGUMENTS to configure the arguments passed to the build system. Default -Dmaven.test.skip=true package.
[builder]     Set $BP_BUILT_MODULE to configure the module to find application artifact in. Default <ROOT>.
[builder]     Set $BP_BUILT_ARTIFACT to configure the built application artifact. Default target/*.[jw]ar.
[builder]     Creating cache directory /home/vcap/.m2
[builder]   Compiled Application: Contributing to layer
[builder]     Executing mvnw -Dmaven.test.skip=true package
[builder] [INFO] Scanning for projects...
[builder] Downloading from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-starter-parent/2.2.6.RELEASE/spring-boot-starter-parent-2.2.6.RELEASE.pom
Downloaded from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-starter-parent/2.2.6.RELEASE/spring-boot-starter-parent-2.2.6.RELEASE.pom (8.1 kB at 8.1 kB/s)
[builder] Downloading from central: https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-dependencies/2.2.6.RELEASE/spring-boot-dependencies-2.2.6.RELEASE.pom
(途中略)
[builder] [INFO] Replacing main artifact with repackaged archive
[builder] [INFO] ------------------------------------------------------------------------
[builder] [INFO] BUILD SUCCESS
[builder] [INFO] ------------------------------------------------------------------------
[builder] [INFO] Total time:  02:16 min
[builder] [INFO] Finished at: 2020-04-28T12:16:49Z
[builder] [INFO] ------------------------------------------------------------------------
[builder]   Removing source code
[builder] 
[builder] Paketo Executable JAR Buildpack 1.2.1
[builder]     Writing env/CLASSPATH
[builder]   Process types:
[builder]     executable-jar: java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher
[builder]     task:           java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher
[builder]     web:            java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher
[builder] 
[builder] Paketo Spring Boot Buildpack 1.5.1
[builder]   Image labels:
[builder]     org.opencontainers.image.title
[builder]     org.opencontainers.image.version
[builder]     org.springframework.boot.spring-configuration-metadata.json
[builder]     org.springframework.boot.version
===> EXPORTING
[exporter] Adding layer 'launcher'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:class-counter'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:java-security-properties'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:jre'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:jvmkill'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:link-local-dns'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:memory-calculator'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:security-providers-configurer'
[exporter] Adding layer 'paketo-buildpacks/executable-jar:class-path'
[exporter] Adding 1/1 app layer(s)
[exporter] Adding layer 'config'
[exporter] *** Images (b012cfa7c940):
[exporter]       index.docker.io/making/pack-spring-boot:latest
[exporter] Adding cache layer 'paketo-buildpacks/bellsoft-liberica:jdk'
[exporter] Adding cache layer 'paketo-buildpacks/build-system:application'
[exporter] Adding cache layer 'paketo-buildpacks/build-system:cache'
[exporter] Adding cache layer 'paketo-buildpacks/executable-jar:class-path'
Successfully built image making/pack-spring-boot
```

> `pack build`時に`--publish`オプションをつけると、Docker Registryでのpushを行います。事前に`docker login`が必要です。

`pack inspect-image`でイメージを解析します。

Mavenによるソースコードから始まるため、初回ビルド時には依存ライブラリのダウンロードが始まります。
依存ライブラリはキャッシュされ、二回目以降はキャッシュが使用されます。

> * JDKのバージョンはビルド時に[環境変数`BP_JAVA_VERSION`を設定](https://github.com/paketo-buildpacks/bellsoft-liberica#configuration)することで指定できます。デフォルトは`11.*`です。(例: `-e BP_JAVA_VERSION=8.*`)

`pack inspect-image`でイメージを解析します。

```
$ pack inspect-image making/pack-spring-boot
Inspecting image: making/pack-spring-boot

REMOTE:
(not present)

LOCAL:

Stack: org.cloudfoundry.stacks.cflinuxfs3

Base Image:
  Reference: 30c2fe64f46f987d570fddf1a9400c0e0f58eebe790f95557b9387e5dcfb08a2
  Top Layer: sha256:70227f7df5ee235dae16d7b6ce4a23b03bb57cadd64a00740d590fb11bbae042

Run Images:
  gcr.io/paketo-buildpacks/run:full-cnb-cf

Buildpacks:
  ID                                         VERSION
  paketo-buildpacks/bellsoft-liberica        2.3.1
  paketo-buildpacks/build-system             1.2.0
  paketo-buildpacks/executable-jar           1.2.1
  paketo-buildpacks/apache-tomcat            1.1.1
  paketo-buildpacks/spring-boot              1.5.1
  paketo-buildpacks/dist-zip                 1.2.1

Processes:
  TYPE                  SHELL        COMMAND                                                                                 ARGS
  web (default)         bash         java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher        
  executable-jar        bash         java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher        
  task                  bash         java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher     
```

Maven以外にもGradleによるビルドもサポートされています。

### jarからビルドする場合

まずはソースコードをビルドしてjarファイルを作成します。

```
mvn -Dmaven.test.skip=true clean package
```

`pack build`の`-p`オプションで作成したjarファイルのパスを指定します。

```
pack build making/pack-spring-boot --no-pull -p target/hello-spring-boot-0.0.1-SNAPSHOT.jar --builder gcr.io/paketo-buildpacks/builder:full-cf
```

次のようなログが出力されます。

```
===> DETECTING
[detector] 5 of 11 buildpacks participating
[detector] paketo-buildpacks/bellsoft-liberica 2.3.1
[detector] paketo-buildpacks/executable-jar    1.2.1
[detector] paketo-buildpacks/apache-tomcat     1.1.1
[detector] paketo-buildpacks/spring-boot       1.5.1
[detector] paketo-buildpacks/dist-zip          1.2.1
===> ANALYZING
[analyzer] Previous image with name "index.docker.io/making/pack-spring-boot:latest" not found
===> RESTORING
===> BUILDING
[builder] 
[builder] Paketo BellSoft Liberica Buildpack 2.3.1
[builder]     Set $BP_JAVA_VERSION to configure the Java version. Default 11.*.
[builder]     Set $BPL_HEAD_ROOM to configure the headroom in memory calculation. Default 0.
[builder]     Set $BPL_LOADED_CLASS_COUNT to configure the number of loaded classes in memory calculation. Default 35% of classes.
[builder]     Set $BPL_THREAD_COUNT to configure the number of threads in memory calculation. Default 250.
[builder]   BellSoft Liberica JRE 11.0.7: Contributing to layer
[builder]     Downloading from https://github.com/bell-sw/Liberica/releases/download/11.0.7+10/bellsoft-jre11.0.7+10-linux-amd64.tar.gz
[builder]     Verifying checksum
[builder]     Expanding to /layers/paketo-buildpacks_bellsoft-liberica/jre
[builder]     Writing env/JAVA_HOME.override
[builder]     Writing env/MALLOC_ARENA_MAX.override
[builder]     Writing profile.d/active-processor-count.sh
[builder]   JVMKill Agent 1.16.0: Contributing to layer
[builder]     Downloading from https://github.com/cloudfoundry/jvmkill/releases/download/v1.16.0.RELEASE/jvmkill-1.16.0-RELEASE.so
[builder]     Verifying checksum
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/jvmkill
[builder]     Writing env/JAVA_OPTS.append
[builder]   Link-Local DNS: Contributing to layer
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/link-local-dns
[builder]     Writing profile.d/link-local-dns.sh
[builder]   Memory Calculator 4.0.0: Contributing to layer
[builder]     Downloading from https://github.com/cloudfoundry/java-buildpack-memory-calculator/releases/download/v4.0.0/memory-calculator-4.0.0.tgz
[builder]     Verifying checksum
[builder]     Expanding to /layers/paketo-buildpacks_bellsoft-liberica/memory-calculator
[builder]     Writing profile.d/memory-calculator.sh
[builder]   Class Counter: Contributing to layer
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/class-counter
[builder]   Java Security Properties: Contributing to layer
[builder]     Writing env.launch/JAVA_OPTS.append
[builder]     Writing env.launch/JAVA_SECURITY_PROPERTIES.override
[builder]   Security Providers Configurer: Contributing to layer
[builder]     Copying to /layers/paketo-buildpacks_bellsoft-liberica/security-providers-configurer
[builder]     Writing profile.d/security-providers-classpath.sh
[builder]     Writing profile.d/security-providers-configurer.sh
[builder] 
[builder] Paketo Executable JAR Buildpack 1.2.1
[builder]     Writing env/CLASSPATH
[builder]   Process types:
[builder]     executable-jar: java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher
[builder]     task:           java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher
[builder]     web:            java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher
[builder] 
[builder] Paketo Spring Boot Buildpack 1.5.1
[builder]   Image labels:
[builder]     org.opencontainers.image.title
[builder]     org.opencontainers.image.version
[builder]     org.springframework.boot.spring-configuration-metadata.json
[builder]     org.springframework.boot.version
===> EXPORTING
[exporter] Adding layer 'launcher'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:class-counter'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:java-security-properties'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:jre'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:jvmkill'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:link-local-dns'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:memory-calculator'
[exporter] Adding layer 'paketo-buildpacks/bellsoft-liberica:security-providers-configurer'
[exporter] Adding layer 'paketo-buildpacks/executable-jar:class-path'
[exporter] Adding 1/1 app layer(s)
[exporter] Adding layer 'config'
[exporter] *** Images (d4d32dd9c38f):
[exporter]       index.docker.io/making/pack-spring-boot:latest
[exporter] Adding cache layer 'paketo-buildpacks/executable-jar:class-path'
Successfully built image making/pack-spring-boot
```

今回はイメージビルド時にMavenによるビルドは実行されません。

> * JDKのバージョンはビルド時に[環境変数`BP_JAVA_VERSION`を設定](https://github.com/paketo-buildpacks/bellsoft-liberica#configuration)することで指定できます。デフォルトは`11.*`です。(例: `-e BP_JAVA_VERSION=8.*`)

`pack inspect-image`でイメージを解析します。

```
$ pack inspect-image making/pack-spring-boot
Inspecting image: making/pack-spring-boot

REMOTE:
(not present)

LOCAL:

Stack: org.cloudfoundry.stacks.cflinuxfs3

Base Image:
  Reference: 30c2fe64f46f987d570fddf1a9400c0e0f58eebe790f95557b9387e5dcfb08a2
  Top Layer: sha256:70227f7df5ee235dae16d7b6ce4a23b03bb57cadd64a00740d590fb11bbae042

Run Images:
  gcr.io/paketo-buildpacks/run:full-cnb-cf

Buildpacks:
  ID                                         VERSION
  paketo-buildpacks/bellsoft-liberica        2.3.1
  paketo-buildpacks/executable-jar           1.2.1
  paketo-buildpacks/apache-tomcat            1.1.1
  paketo-buildpacks/spring-boot              1.5.1
  paketo-buildpacks/dist-zip                 1.2.1

Processes:
  TYPE                  SHELL        COMMAND                                                                                 ARGS
  web (default)         bash         java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher        
  executable-jar        bash         java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher        
  task                  bash         java -cp "${CLASSPATH}" ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher       
```

### イメージの実行

作成したイメージを`docker run`で起動します。

```
docker run --rm -p 8080:8080 making/pack-spring-boot
```

起動時に次のようなログが出力されます。

```
Container memory limit unset. Configuring JVM for 1G container.
Calculated JVM Memory Configuration: -XX:MaxDirectMemorySize=10M -XX:MaxMetaspaceSize=86460K -XX:ReservedCodeCacheSize=240M -Xss1M -Xmx450115K (Head Room: 0%, Loaded Class Count: 12851, Thread Count: 250, Total Memory: 1073741824)

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::        (v2.2.6.RELEASE)

2020-04-28 11:48:02.255  INFO 1 --- [           main] hello.HelloSpringBootApplication         : Starting HelloSpringBootApplication on 89d27837109d with PID 1 (/workspace/BOOT-INF/classes started by cnb in /workspace)
2020-04-28 11:48:02.269  INFO 1 --- [           main] hello.HelloSpringBootApplication         : No active profile set, falling back to default profiles: default
2020-04-28 11:48:03.870  INFO 1 --- [           main] o.s.b.web.embedded.netty.NettyWebServer  : Netty started on port(s): 8080
2020-04-28 11:48:03.876  INFO 1 --- [           main] hello.HelloSpringBootApplication         : Started HelloSpringBootApplication in 2.197 seconds (JVM running for 2.776)
```

JVMのメモリが自動で設定されていることに注目してください。

アプリケーションにアクセスします。

```
$ curl localhost:8080 -w '\n'
Hello World!
```

Docker Imageのサイズを確認します。

```
$ docker images | grep making/pack-spring-boot
making/pack-spring-boot              latest              b012cfa7c940        40 years ago        1.24GB
```

使用されるBuildpackは同じですが、ベースイメージのサイズが大きいため、`gcr.io/paketo-buildpacks/builder:base`でビルドした場合に比べてイメージサイズが大きいです。

Java Buildpackの細かい設定は
https://github.com/paketo-buildpacks/java
を確認してください。

おわったらDocker Imageを削除します。

```
docker rmi making/pack-spring-boot
```