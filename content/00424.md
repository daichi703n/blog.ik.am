---
title: Spring Bootアプリのデプロイ先として最適なPivotal Web Servies及びPivotal Cloud Foundry
tags: ["Cloud Foundry", "Pivotal Web Services", "Pivotal Cloud Foundry", "Spring Boot", "Java"]
categories: ["Programming", "Java", "org", "springframework", "boot"]
---

**目次**
<!-- toc -->

### はじめに

Cloud Foundry（特に、[Pivotal Web Services (以降、PWS)](https://run.pivotal.io)及び[Pivotal Cloud Foundry (以降、PCF)](http://docs.pivotal.io/pivotalcf)）はSpring Bootアプリケーションをデプロイする先として、最適なプラットフォームになるべく機能が追加されている。

Cloud FoundryとSpring Bootの連携としては

* `cf push -p app.jar`のみでデプロイ可能
* `cloud`プロファイルの自動適用
* [Spring Cloud Connector](http://cloud.spring.io/spring-cloud-connectors/)でDBなどの接続情報設定不要化
* Spring Boot Actuatorの[Cloud Foundry向けEndpoint](http://docs.spring.io/spring-boot/docs/1.5.4.RELEASE/reference/html/production-ready-cloudfoundry.html)
* Apps Manager(アプリケーション管理UI)の[Spring Boot Actuator連携](http://docs.pivotal.io/pivotalcf/console/using-actuators.html) (**PWS, PCFのみ**)
* GoRouterによるZipkin Headerの付与
* Hosted Zipkinとして使える[PCF Metrics](https://docs.pivotal.io/pcf-metrics)の[Trace Explorer](https://docs.pivotal.io/pcf-metrics/1-3/using.html#trace) (**PWS, PCFのみ**)
* Managed Config Server, Eureka Server, Hystrix Dashboardを提供する[Spring Cloud Services](http://docs.pivotal.io/spring-cloud-services) (**PWS, PCFのみ**)

が挙げられるが、特にわかりやすく便利なのがApps ManagerのSpring Boot Actuator連携。以前にも[紹介](https://blog.ik.am/entries/401)したが、PCF 1.11でUIが変わりさらに機能が加わるので改めて紹介する。PWSではすでに[利用可能](https://console.run.pivotal.io/)になっている。

### Apps ManagerにサポートされているActuatorエンドポイント

Spring Boot Actuatorには現状、デフォルトで次のエンドポイントが用意されている。Apps Managerがサポートしているエンドポイントにマークを入れた。


| Path | Short Description | Apps Manager Support |
| --- | --- | --- |
| `/auditevents ` | 認証の成功失敗に関する監査ログを表示 |  |
| `/autoconfig` | AutoConfigurationのうち、有効になっているもの、なっていないものを列挙 |  |
| `/beans ` | Springに管理されているBean一覧を表示 |  |
| `/configprops` | `@ConfigurationProperties`のついたBeanに実際に設定されている値を表示 |  |
| `/dump` | スレッドダンプを表示 | &#127381; |
| `/env` | 環境変数や設定されたプロパティを表示 |  |
| `/health` | データベースなどのヘルスチェック結果を表示 | &#9989; |
| `/info` | アプリケーションの情報を表示 | &#9989; |
| `/loggers` | ログレベルの表示及び変更 | &#9989; |
| `/metrics` | アプリケーションのメトリクスを表示 |  |
| `/mappings ` | `@RequestMapping`で定義されているパスとContollerメソッドのマッピング一覧を表示 |  |
| `/trace` | リクエストのトレースログを表示 | &#127381; |
| `/heapdump` | GZipで圧縮された`hprof`のheapdumpファイルをダウンロード | &#127381; |

&#9989;がついているものが前回紹介した時からApps Managerがサポートしていた機能で、&#127381;がついているものがPCF 1.11で追加されるもの(PWSではすでに利用可能)。

Actuator連携の嬉しい点は**認可対策が自動で行われる**点。
Spring Boot 1.5からActuatorのエンドポイントがデフォルトで認可制御されるようになった。Actuatorは機密情報を含む場合があるため、基本的にセキュリティの設定が必須であるが、PWS / PCFにデプロイした場合は、認可設定をしたままでもApps Manager上からはアクセスできるので、開発者がケアしないといけない点が減る。

### プロジェクトの設定

普通のSpring Bootプロジェクトを[Spring Initializr](https://start.spring.io)から作成すればいいが、Acutator連携を試したいので、`spring-boot-start-actuator`が必要。また、対応するSpring Bootのバージョンは1.5以上。

``` xml
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

infoエンドポイントにアプリケーションのバージョン情報を出力させたい場合は、次のように`spring-boot-maven-plugin`に`build-info`goalを追加する必要がある。

``` xml
<plugin>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-maven-plugin</artifactId>
	<executions>
		<execution>
			<goals>
				<goal>build-info</goal>
			</goals>
		</execution>
	</executions>
</plugin>
```

また、infoエンドポントにGitのメタ情報を出力させたい場合は、次のように

``` xml
<plugin>
	<groupId>pl.project13.maven</groupId>
	<artifactId>git-commit-id-plugin</artifactId>
</plugin>
```

さらに、Git情報にremoteのurlなど詳細な情報を含めたい場合は`application.properties`に次の設定が必要である。

```
management.info.git.mode=full
```

以上の設定は特にApps Manager連携に特化したものではない。

> Memo: 
> 
> 自己証明書使ったPivotal Cloud Foundryの場合、`application.properties`に次の設定も必要。
> 
> ```
> management.cloudfoundry.skip-ssl-validation=true
> ```

### アプリケーションのデプロイ

Pivotal Web Servicesを使う場合は、アカウントを作成して

```
$ cf login -a api.run.pivotal.io
```

でログイン。

```
$ ./mvnw clean package -DskipTests=true
```

で

```
$ cf push your-app-name -p target/you-app-name-0.0.1-SNAPSHOT.jar 
```

でデプロイ完了。

<img src="https://user-images.githubusercontent.com/106908/27024982-c3048028-4f93-11e7-9794-3e3eaec2e0f8.png" width="60%" />

[Apps Manager](https://console.run.pivotal.io)にログインして、デプロイしたアプリケーションを開き、左上にSpring Bootマークが出ていたらAcutaotr連携成功。


### healthエンドポイント

一番わかりやすいhealthエンドポイントから。Apps Managerの「Instances」を開くと、`/health`エンドポイントの結果が出力される。

<img src="https://user-images.githubusercontent.com/106908/27025558-e98df678-4f95-11e7-96eb-3418c1abe6f0.png" width="60%" />

どこかに障害が発生していると赤文字で**DOWN**が表示される。

「View JSON」をクリックすると、JSONの出力結果がそのまま表示される。

<img src="https://user-images.githubusercontent.com/106908/27026589-37d293a4-4f99-11e7-9d7e-220ad52b5f7a.png" width="40%" />


```
$ cf scale your-app-name -i 2
```

でスケールアウトしても、各インスタンスの情報がそれぞれ出力されてGood。

<img src="https://user-images.githubusercontent.com/106908/27026879-41705562-4f9a-11e7-8a74-7de319821ccf.png" width="60%" />

連携サービスが多くなれば多くなるほどこの機能は重宝する。

### infoエンドポイント

infoエンドポイントの情報は「Settings」タブの真ん中あたりの「Spring Info」に表示される。

Gitのコミット情報が表示されており、SHAハッシュのリンクをクリックすればRemote先(Githubなど)のコミットログに飛べる。

<img src="https://user-images.githubusercontent.com/106908/27029755-9b0b2606-4fa4-11e7-8f30-f3d3abb4768a.png" width="60%" />


地味だけど、右上にもコミットのリンクが表示されている。

![image](https://user-images.githubusercontent.com/106908/27030052-c06d1bd8-4fa5-11e7-8c80-d6509b598351.png)


「VIEW RAW JSON」をクリックすれば`/info`のJSONの出力結果がそのまま表示される。アプリケーションのバージョンはここから確認できる。

<img src="https://user-images.githubusercontent.com/106908/27029878-1820f8aa-4fa5-11e7-896f-d0399e63b432.png" width="40%" />



### loggersエンドポイント

### dumpエンドポイント

### traceエンドポイント

### heapdumpエンドポイント

